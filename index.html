<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>15 Week Body Transformation (Jan to May 2026)</title>

  <script>
  // Global error trap (helps when something silently breaks)
  window.addEventListener("error", (ev) => {
    try{
      console.error("App error:", ev.error || ev.message);
      const el = document.getElementById("authMsg");
      if(el){
        el.innerHTML = '<b>Cloud sync:</b> <span class="err">JavaScript error occurred. Open DevTools Console for details.</span>';
      }
    }catch(_){}
  });
  </script>

  <style>
    :root{
      --bg0:#04070c;
      --bg1:#070d18;
      --bg2:#0b1424;
      --card:#0b1424cc;
      --card2:#0b1424aa;
      --line:#18304e;
      --line2:#1c3758;
      --text:#d9e6ff;
      --muted:#9db4d6;
      --muted2:#7f97bd;
      --pill:#0f223a;
      --pill2:#102a4a;
      --good:#2dd4bf;
      --warn:#f59e0b;
      --bad:#fb7185;
      --accent:#60a5fa;
      --accent2:#93c5fd;
      --shadow: 0 18px 40px rgba(0,0,0,.55);
      --r:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1400px 900px at 20% 12%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(1200px 800px at 80% 25%, rgba(45,212,191,.18), transparent 55%),
        radial-gradient(1200px 900px at 50% 100%, rgba(59,130,246,.18), transparent 50%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg0));
      overflow-x:hidden;
    }

    a{ color:var(--accent2); }

    .wrap{
      max-width: 1340px;
      margin: 26px auto 42px;
      padding: 0 18px 30px;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
    }

    h1{
      margin:0;
      font-weight:800;
      letter-spacing:.2px;
      font-size: 22px;
      line-height:1.15;
      text-shadow: 0 2px 12px rgba(0,0,0,.45);
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
      max-width: 920px;
    }

    .pills{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      padding-top:2px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(16,42,74,.75), rgba(10,22,38,.65));
      border:1px solid rgba(96,165,250,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      color:var(--text);
      font-size:12px;
      white-space:nowrap;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:var(--accent);
      box-shadow: 0 0 0 3px rgba(96,165,250,.18);
    }
    .dot.good{ background:var(--good); box-shadow:0 0 0 3px rgba(45,212,191,.16); }
    .dot.warn{ background:var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.16); }
    .dot.bad{ background:var(--bad); box-shadow:0 0 0 3px rgba(251,113,133,.16); }

    .grid2{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      margin-top:14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(12,26,46,.92), rgba(7,15,28,.78));
      border:1px solid rgba(96,165,250,.16);
      border-top:1px solid rgba(147,197,253,.18);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom: 1px solid rgba(96,165,250,.12);
      background: linear-gradient(180deg, rgba(9,18,33,.62), rgba(9,18,33,.20));
    }
    .head .t{
      font-weight:700;
      font-size:13.5px;
      letter-spacing:.2px;
    }
    .head .pill{
      padding:6px 9px;
      font-size:11.5px;
    }

    .body{
      padding:14px;
    }

    .coach{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .coach .mini{
      border-radius: 14px;
      border:1px solid rgba(96,165,250,.14);
      background: linear-gradient(180deg, rgba(10,20,38,.65), rgba(7,14,26,.42));
      padding:10px 10px 9px;
      min-height: 72px;
    }
    .mini .k{
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .mini .v{
      font-size:13px;
      font-weight:700;
      margin-bottom:6px;
    }
    .mini .s{
      font-size:11.5px;
      color:var(--muted2);
    }

    .snapGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }

    .kpi{
      border-radius: 14px;
      border:1px solid rgba(96,165,250,.14);
      background: linear-gradient(180deg, rgba(10,20,38,.65), rgba(7,14,26,.42));
      padding:12px 12px 10px;
      min-height: 78px;
    }
    .kpi .k{ font-size:11px; color:var(--muted); margin-bottom:7px; }
    .kpi .v{ font-size:16px; font-weight:800; letter-spacing:.3px; margin-bottom:6px;}
    .kpi .s{ font-size:11.5px; color:var(--muted2); }

    .settingsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }

    label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select{
      width:100%;
      height:34px;
      border-radius: 11px;
      border:1px solid rgba(96,165,250,.18);
      background: rgba(11,20,36,.70);
      color:var(--text);
      padding: 0 10px;
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(147,197,253,.34);
      box-shadow: 0 0 0 3px rgba(96,165,250,.12);
    }

    .btnRow{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .btn{
      border:1px solid rgba(96,165,250,.22);
      background: linear-gradient(180deg, rgba(16,42,74,.75), rgba(10,22,38,.60));
      color:var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(147,197,253,.35); }
    .btn.danger{ border-color: rgba(251,113,133,.35); }
    .btn.danger:hover{ border-color: rgba(251,113,133,.55); }
    .btn:active{ transform: translateY(1px); }

    .authRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto auto;
      gap:10px;
      align-items:end;
      margin-bottom:8px;
    }
    .authMsg{
      margin-top:6px;
      font-size:11.5px;
      color:var(--muted2);
    }
    .authMsg .ok{ color:rgba(45,212,191,.95); font-weight:700;}
    .authMsg .warn{ color:rgba(245,158,11,.98); font-weight:700;}
    .authMsg .err{ color:rgba(251,113,133,.95); font-weight:800;}

    .monthCard{
      margin-top:14px;
    }

    .monthTabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid rgba(96,165,250,.12);
      background: linear-gradient(180deg, rgba(9,18,33,.62), rgba(9,18,33,.20));
    }
    .tab{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius: 14px;
      border:1px solid rgba(96,165,250,.18);
      background: rgba(11,20,36,.55);
      cursor:pointer;
      user-select:none;
      font-weight:800;
      font-size:12px;
      color:var(--text);
    }
    .tab small{
      font-weight:900;
      color:rgba(157,180,214,.85);
      background: rgba(16,42,74,.55);
      border:1px solid rgba(96,165,250,.18);
      padding:3px 7px;
      border-radius: 999px;
    }
    .tab.active{
      border-color: rgba(147,197,253,.40);
      box-shadow: 0 0 0 3px rgba(96,165,250,.10);
      background: rgba(16,42,74,.55);
    }

    .calWrap{ padding:14px; }

    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
      margin-bottom:10px;
    }
    .dow div{
      color:var(--muted);
      font-size:11px;
      padding-left:2px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    }

    .day{
      border-radius: 16px;
      border:1px solid rgba(96,165,250,.14);
      background: linear-gradient(180deg, rgba(10,20,38,.60), rgba(7,14,26,.40));
      min-height: 124px;
      padding:10px 10px 10px;
      position:relative;
      overflow:hidden;
    }

    .day .num{
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
    }

    .badges{
      position:absolute;
      top:8px;
      right:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      max-width: 74%;
    }
    .badge{
      font-size:10px;
      font-weight:900;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(96,165,250,.18);
      background: rgba(16,42,74,.55);
      color:rgba(217,230,255,.92);
    }
    .badge.fast{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); color: rgba(255,215,160,.95); }
    .badge.walk{ border-color: rgba(45,212,191,.35); background: rgba(45,212,191,.10); color: rgba(182,255,245,.95); }
    .badge.high{ border-color: rgba(96,165,250,.40); background: rgba(96,165,250,.12); color: rgba(210,230,255,.98); }
    .badge.break{ border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.10); color: rgba(255,205,214,.98); }

    .line{
      margin-top:9px;
      font-size:11.5px;
      color:var(--muted);
    }
    .val{
      margin-top:4px;
      font-weight:800;
      color:rgba(217,230,255,.95);
      font-size:12.5px;
    }
    .note{
      margin-top:8px;
      font-size:11.5px;
      color:rgba(157,180,214,.9);
      line-height:1.25;
    }

    .day.empty{
      opacity:.35;
      filter:saturate(.8);
    }

    .day.ontrack{
      border-color: rgba(45,212,191,.32);
      box-shadow: inset 0 0 0 1px rgba(45,212,191,.10);
    }
    .day.warn{
      border-color: rgba(245,158,11,.35);
      box-shadow: inset 0 0 0 1px rgba(245,158,11,.10);
    }
    .day.off{
      border-color: rgba(251,113,133,.42);
      box-shadow: inset 0 0 0 1px rgba(251,113,133,.12);
    }

    .editRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .editRow textarea{
      width:100%;
      min-height: 72px;
      resize:vertical;
      border-radius: 12px;
      border:1px solid rgba(96,165,250,.18);
      background: rgba(11,20,36,.70);
      color:var(--text);
      padding:10px;
      outline:none;
      font-family: inherit;
      font-size:12px;
      line-height:1.25;
    }

    .footerRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding: 12px 14px;
      border-top:1px solid rgba(96,165,250,.12);
      background: linear-gradient(180deg, rgba(9,18,33,.20), rgba(9,18,33,.45));
    }
    .small{
      font-size:11.5px;
      color:var(--muted2);
      line-height:1.25;
    }

    @media (max-width: 1100px){
      .grid2{ grid-template-columns: 1fr; }
      .coach{ grid-template-columns: repeat(2, 1fr); }
      .snapGrid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 720px){
      .coach{ grid-template-columns: 1fr; }
      .snapGrid{ grid-template-columns: 1fr; }
      .settingsGrid{ grid-template-columns: 1fr; }
      .authRow{ grid-template-columns: 1fr 1fr; }
      .btnRow{ justify-content:flex-start; }
      .grid{ grid-template-columns: repeat(2, 1fr); }
      .dow{ display:none; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div>
        <h1>15 Week Body Transformation (Jan to May 2026)</h1>
        <div class="sub">
          Fast highlighted: <b>2026-01-02</b> to <b>2026-01-03</b> only. Jan 4 is a standard day (not fasting).
          High-carb schedule: <b>Week 3+</b> Sundays, and <b>Week 10+</b> Sundays + Wednesdays.
          Dynamic calories adjust automatically as your weight drops (BMR adjustment). Reverse diet is built in for <b>Apr 20</b> through <b>May 14</b> to ramp toward <b>2700</b>.
        </div>
      </div>

      <div class="pills">
        <div class="pill"><span class="dot" id="statusDot"></span> <b>Status:</b> <span id="statusText">Ready</span></div>
        <div class="pill"><span class="dot good" id="saveDot"></span> <b>Data:</b> <span id="saveText">Saved locally</span></div>
      </div>
    </div>

    <section class="card">
      <div class="head">
        <div class="t">Coach Suggestions</div>
        <div class="pill"><span class="dot" style="background:rgba(147,197,253,.9)"></span> <b>Guidance:</b> <span id="coachMode">-</span></div>
      </div>
      <div class="body">
        <div class="coach">
          <div class="mini">
            <div class="k">Primary action</div>
            <div class="v" id="coachAction">-</div>
            <div class="s">Based on adherence and weigh-in trend</div>
          </div>
          <div class="mini">
            <div class="k">Next weigh-in target</div>
            <div class="v" id="coachTarget">-</div>
            <div class="s">Shown on upcoming Mon or Thu</div>
          </div>
          <div class="mini">
            <div class="k">Week 15 Thursday target</div>
            <div class="v" id="coachW15">-</div>
            <div class="s">End-of-block expectation</div>
          </div>
          <div class="mini">
            <div class="k">Dynamic calorie logic</div>
            <div class="v" id="coachDyn">-</div>
            <div class="s">Uses your latest logged weight</div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid2">

      <section class="card">
        <div class="head">
          <div class="t">Snapshot</div>
          <div class="pill"><span class="dot" id="trackDot"></span> <b>On track:</b> <span id="trackText">-</span></div>
        </div>

        <div class="body">
          <div class="snapGrid">
            <div class="kpi">
              <div class="k">Current weight (latest)</div>
              <div class="v" id="kpiWeight">-</div>
              <div class="s">Latest logged weigh-in</div>
            </div>
            <div class="kpi">
              <div class="k">Current BF% (latest)</div>
              <div class="v" id="kpiBf">-</div>
              <div class="s">From your Fitdays entries</div>
            </div>
            <div class="kpi">
              <div class="k">7-day avg calories</div>
              <div class="v" id="kpiCals">-</div>
              <div class="s">From logged calories</div>
            </div>
            <div class="kpi">
              <div class="k">7-day adherence</div>
              <div class="v" id="kpiAdh">-</div>
              <div class="s">Within ± window</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="head">
          <div class="t">Settings</div>
          <div class="pill"><span class="dot" style="background:rgba(147,197,253,.9)"></span> <b>Diet:</b> <span id="dietPill"><b>Diet:</b> -</span></div>
        </div>

        <div class="body">
          <div class="authRow">
            <div>
              <label>Cloud sync email</label>
              <input id="cloudEmail" type="email" placeholder="you@email.com"/>
            </div>
            <div>
              <label>Cloud sync password</label>
              <input id="cloudPass" type="password" placeholder="password"/>
            </div>
            <button class="btn" id="signInBtn">Sign In (Enable Sync)</button>
            <button class="btn" id="signOutBtn">Sign Out</button>
          </div>
          <div class="authMsg" id="authMsg">
            <b>Cloud sync:</b> <span class="warn">Not signed in.</span> If sign-in fails, check DevTools Console for details.
          </div>

          <div class="settingsGrid" style="margin-top:10px;">
            <div>
              <label>Official start weigh-in date (Mon)</label>
              <input type="date" id="startDate" value="2026-01-05"/>
            </div>
            <div>
              <label>Official start weight (lbs)</label>
              <input type="number" id="startWeight" step="0.1" value="221.6"/>
            </div>
            <div>
              <label>Official start body fat (%)</label>
              <input type="number" id="startBf" step="0.1" value="25.0"/>
            </div>
            <div>
              <label>Base target calories (normal)</label>
              <input type="number" id="targetCal" step="10" value="2200"/>
            </div>
          </div>

          <div class="settingsGrid" style="margin-top:10px;">
            <div>
              <label>High-carb day calories</label>
              <input type="number" id="highCal" step="10" value="2400"/>
            </div>
            <div>
              <label>High-carb starts (week #)</label>
              <input type="number" id="highStartWeek" min="1" step="1" value="3"/>
            </div>
            <div>
              <label>Second high-carb starts (week #)</label>
              <input type="number" id="secondHighStartWeek" min="1" step="1" value="10"/>
            </div>
            <div>
              <label>BMR adjust (kcal per lb change)</label>
              <input type="number" id="kcalPerLb" min="0" step="1" value="10"/>
            </div>
          </div>

          <div class="settingsGrid" style="margin-top:10px;">
            <div>
              <label>Minimum calories floor</label>
              <input type="number" id="minCal" step="10" value="1700"/>
            </div>
            <div>
              <label>Adherence window (kcal)</label>
              <input type="number" id="adhWindow" step="10" value="150"/>
            </div>
            <div>
              <label>Primary high-carb day</label>
              <select id="primaryHighDow">
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
            </div>
            <div>
              <label>Second high-carb day (week 10+)</label>
              <select id="secondHighDow">
                <option value="0">Sunday</option>
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3" selected>Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
            </div>
          </div>

          <div class="btnRow">
            <button class="btn" id="importCsvBtn">Import Calories CSV</button>
            <button class="btn" id="exportBtn">Export JSON</button>
            <button class="btn" id="importBtn">Import JSON</button>
            <button class="btn danger" id="resetBtn">Reset All Data</button>
          </div>

          <div class="small" style="margin-top:10px;">
            Dynamic calories already account for BMR drop as weight decreases (kcal per lb).
            Reverse diet overrides targets from Apr 20 to May 14 to ramp up to 2700.
          </div>
        </div>
      </section>

    </div>

    <section class="card monthCard">
      <div class="monthTabs" id="monthTabs"></div>
      <div class="calWrap">
        <div class="dow">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div class="grid" id="calGrid"></div>
      </div>

      <div class="footerRow">
        <div class="pill"><span class="dot" style="background:rgba(147,197,253,.9)"></span> <b>Month:</b> <span id="activeMonthName">-</span></div>
        <div class="pill"><span class="dot" style="background:rgba(45,212,191,.9)"></span> <b>Logged days:</b> <span id="loggedDays">-</span></div>
      </div>
    </section>

  </div>

  <input id="filePicker" type="file" accept=".json,.csv" style="display:none"/>

<script>
/* ============================
   15 Week Body Transformation
   ============================ */

  // ======= Core dates =======
  const FAST_START = "2026-01-02";
  const FAST_END   = "2026-01-03";

  const REVERSE_START = "2026-04-20";
  const REVERSE_END   = "2026-05-14";
  const REVERSE_TARGET = 2700;

  // Month tab list (Jan -> May)
  const MONTHS = [
    {y:2026, m:0, name:"January 2026"},
    {y:2026, m:1, name:"February 2026"},
    {y:2026, m:2, name:"March 2026"},
    {y:2026, m:3, name:"April 2026"},
    {y:2026, m:4, name:"May 2026"},
  ];
  function mkey(y,m){ return `${y}-${m}`; }

  // ======= Storage =======
  const STORAGE_KEY = "bt15w_state_v1";
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){
      console.warn("loadState failed:", e);
      return null;
    }
  }
  function cacheStateLocally(s){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){}
  }

  // ======= Supabase config =======
  // NOTE: This must be your "anon public" key from Supabase Project Settings -> API.
  const SUPABASE_URL = "https://dklnhdjxplpqnrjziqkq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrbG5oZGp4cGxwcW5yanppcWtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYxNjIxNjEsImV4cCI6MjA1MTczODIxNjF9.RrbG5OZ6P4cGwcWc5yan";
  let supabase = null;

  const authMsgEl = document.getElementById("authMsg");

  function setAuthMsg(type, html){
    const cls = type === "ok" ? "ok" : (type === "err" ? "err" : "warn");
    authMsgEl.innerHTML = `<b>Cloud sync:</b> <span class="${cls}">${html}</span>`;
  }

  function ensureSupabase(){
    try{
      if(!window.supabase || !window.supabase.createClient){
        setAuthMsg("err", "Supabase library did not load. Check CDN/network.");
        return null;
      }
      if(!supabase){
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
      return supabase;
    }catch(e){
      console.error("Supabase init error:", e);
      setAuthMsg("err", "Supabase init failed. Open console.");
      return null;
    }
  }

  async function getUserSafe(){
    const sb = ensureSupabase();
    if(!sb) return null;
    try{
      const { data, error } = await sb.auth.getUser();
      if(error){ console.warn("getUser error:", error); return null; }
      return data.user || null;
    }catch(e){
      console.warn("getUser exception:", e);
      return null;
    }
  }

  async function cloudLoadState() {
    const sb = ensureSupabase();
    if(!sb) return null;
    const user = await getUserSafe();
    if (!user) return null;

    try{
      const { data, error } = await sb
        .from("tracker_states")
        .select("state")
        .eq("user_id", user.id)
        .single();

      if (error) {
        // no row yet is normal; treat as empty
        console.warn("cloudLoadState:", error);
        return null;
      }
      return data?.state || null;
    }catch(e){
      console.error("cloudLoadState exception:", e);
      return null;
    }
  }

  async function cloudSaveState(s) {
    const sb = ensureSupabase();
    if(!sb) return false;
    const user = await getUserSafe();
    if (!user) return false;

    try{
      const payload = { user_id: user.id, state: s, updated_at: new Date().toISOString() };
      const { error } = await sb
        .from("tracker_states")
        .upsert(payload, { onConflict: "user_id" });

      if (error) {
        console.error("cloudSaveState error:", error);
        setAuthMsg("err", `Save failed: ${error.message || error}`);
        return false;
      }
      return true;
    }catch(e){
      console.error("cloudSaveState exception:", e);
      setAuthMsg("err", "Save failed (exception). Open console.");
      return false;
    }
  }

  // ======= App state =======
  const defaultState = {
    settings: {
      startDate: "2026-01-05",
      startWeight: 221.6,
      startBf: 25.0,
      targetCal: 2200,
      highCal: 2400,
      highStartWeek: 3,
      secondHighStartWeek: 10,
      kcalPerLb: 10,
      minCal: 1700,
      adhWindow: 150,
      primaryHighDow: 0,  // Sunday
      secondHighDow: 3    // Wednesday
    },
    logs: {
      // "YYYY-MM-DD": { cals: number|null, wt:number|null, bf:number|null, note:string, tags:[] }
    },
    ui: {
      activeMonthKey: mkey(2026,0)
    },
    cloud: {
      enabled: false
    }
  };

  function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

  let state = loadState() || deepClone(defaultState);

  // ======= UI refs =======
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const saveDot = document.getElementById("saveDot");
  const saveText = document.getElementById("saveText");

  const coachModeEl = document.getElementById("coachMode");
  const coachActionEl = document.getElementById("coachAction");
  const coachTargetEl = document.getElementById("coachTarget");
  const coachW15El = document.getElementById("coachW15");
  const coachDynEl = document.getElementById("coachDyn");

  const trackDot = document.getElementById("trackDot");
  const trackText = document.getElementById("trackText");

  const kpiWeight = document.getElementById("kpiWeight");
  const kpiBf = document.getElementById("kpiBf");
  const kpiCals = document.getElementById("kpiCals");
  const kpiAdh = document.getElementById("kpiAdh");

  const startDateEl = document.getElementById("startDate");
  const startWeightEl = document.getElementById("startWeight");
  const startBfEl = document.getElementById("startBf"); /* FIXED */
  const targetCalEl   = document.getElementById("targetCal");
  const highCalEl     = document.getElementById("highCal");
  const highStartWeekEl = document.getElementById("highStartWeek");
  const secondHighStartWeekEl = document.getElementById("secondHighStartWeek");
  const kcalPerLbEl   = document.getElementById("kcalPerLb");
  const minCalEl      = document.getElementById("minCal");
  const adhWindowEl   = document.getElementById("adhWindow");
  const primaryHighDowEl = document.getElementById("primaryHighDow");
  const secondHighDowEl  = document.getElementById("secondHighDow");

  const monthTabsEl = document.getElementById("monthTabs");
  const calGridEl = document.getElementById("calGrid");
  const activeMonthNameEl = document.getElementById("activeMonthName");
  const loggedDaysEl = document.getElementById("loggedDays");

  const cloudEmailEl = document.getElementById("cloudEmail");
  const cloudPassEl  = document.getElementById("cloudPass");

  // ======= Helpers =======
  function fmt(n, d=1){
    if(n===null || n===undefined || Number.isNaN(n)) return "-";
    return Number(n).toFixed(d);
  }
  function pad2(x){ return String(x).padStart(2,"0"); }
  function toDS(y,m,d){ return `${y}-${pad2(m+1)}-${pad2(d)}`; }
  function dsToDate(ds){
    const [y,mo,da]=ds.split("-").map(Number);
    return new Date(y, mo-1, da);
  }
  function todayDS(){
    const t=new Date();
    return toDS(t.getFullYear(), t.getMonth(), t.getDate());
  }
  function clamp(n, lo, hi){
    if(n < lo) return lo;
    if(hi !== null && n > hi) return hi;
    return n;
  }
  function isFastDay(ds){ return ds>=FAST_START && ds<=FAST_END; }
  function inReverseWindow(ds){ return ds>=REVERSE_START && ds<=REVERSE_END; }

  function weekIndexFromStart(ds){
    const sd = state.settings.startDate;
    const a = dsToDate(sd);
    const b = dsToDate(ds);
    const diffDays = Math.floor((b - a) / (1000*60*60*24));
    return Math.floor(diffDays/7) + 1; // week # (1-based)
  }

  function isWeighDay(ds){
    const d = dsToDate(ds).getDay(); // Sun 0
    return (d===1 || d===4); // Mon + Thu
  }

  function getLatestWeightBefore(ds){
    const keys = Object.keys(state.logs).sort();
    let best = null;
    for(const k of keys){
      if(k<=ds && state.logs[k] && typeof state.logs[k].wt === "number"){
        best = state.logs[k].wt;
      }
    }
    return best;
  }

  function bmrAdjustedTarget(ds){
    const s = state.settings;
    let base = Number(s.targetCal) || 0;

    // reverse diet override
    if(inReverseWindow(ds)){
      const start = dsToDate(REVERSE_START);
      const end = dsToDate(REVERSE_END);
      const cur = dsToDate(ds);
      const span = Math.max(1, Math.round((end - start)/(1000*60*60*24)));
      const step = Math.round((cur - start)/(1000*60*60*24));
      const t = clamp(step/span, 0, 1);
      return Math.round(base + (REVERSE_TARGET - base)*t);
    }

    // BMR drop logic: adjust calories downward by (startWeight - latestWeight)*kcalPerLb
    const w0 = Number(s.startWeight) || 0;
    const w = getLatestWeightBefore(ds);
    const latest = (typeof w === "number") ? w : w0;
    const delta = (w0 - latest);
    const adj = Math.round(delta * (Number(s.kcalPerLb)||0));
    const target = base - adj;
    return Math.max(Number(s.minCal)||0, Math.round(target));
  }

  function isHighCarbDay(ds){
    const s = state.settings;
    const wk = weekIndexFromStart(ds);
    const dow = dsToDate(ds).getDay();

    if(wk < Number(s.highStartWeek)) return false;
    if(dow === Number(s.primaryHighDow)) return true;
    if(wk >= Number(s.secondHighStartWeek) && dow === Number(s.secondHighDow)) return true;
    return false;
  }

  function expectedCalories(ds){
    if(isFastDay(ds)) return 0;
    if(isHighCarbDay(ds)) return Number(state.settings.highCal) || 0;
    return bmrAdjustedTarget(ds);
  }

  function expectedWeightRange(ds){
    // Simple linear trend expectation from start weight down to ~202 by end of 15 weeks
    const start = Number(state.settings.startWeight)||0;
    const startD = dsToDate(state.settings.startDate);
    const curD = dsToDate(ds);
    const day = Math.max(0, Math.floor((curD - startD)/(1000*60*60*24)));
    const total = 15*7;
    const goal = 202;
    const t = clamp(day/total, 0, 1);
    const mid = start + (goal-start)*t;
    return { lo: mid-0.5, hi: mid+0.5 };
  }

  function expectedBf(ds){
    const bf0 = Number(state.settings.startBf)||0;
    const startD = dsToDate(state.settings.startDate);
    const curD = dsToDate(ds);
    const day = Math.max(0, Math.floor((curD - startD)/(1000*60*60*24)));
    const total = 15*7;
    const bfGoal = 18.0;
    const t = clamp(day/total, 0, 1);
    const mid = bf0 + (bfGoal-bf0)*t;
    return { lo: mid-0.3, hi: mid+0.3 };
  }

  // ======= Save mechanics =======
  function pulseSaved(){
    saveDot.classList.remove("good","warn","bad");
    saveDot.classList.add("good");
    saveText.textContent = state.cloud.enabled ? "Saved (local + cloud)" : "Saved locally";
  }

  function saveState(){
    cacheStateLocally(state);
    if(state.cloud.enabled){
      cloudSaveState(state).then(ok=>{
        if(ok){
          pulseSaved();
          setAuthMsg("ok", "Signed in. Sync enabled.");
        }
      });
    }else{
      pulseSaved();
    }
  }

  // ======= Render month tabs =======
  function computeMonthLogs(){
    const y = Number(state.ui.activeMonthKey.split("-")[0]);
    const m = Number(state.ui.activeMonthKey.split("-")[1]);
    let count = 0;
    for(const ds of Object.keys(state.logs)){
      const d = dsToDate(ds);
      if(d.getFullYear()===y && d.getMonth()===m){
        const L = state.logs[ds]||{};
        if(L.cals!=null || L.wt!=null || L.bf!=null || (L.note && L.note.trim().length)) count++;
      }
    }
    return count;
  }

  function renderMonthTabs(){
    monthTabsEl.innerHTML = "";
    for(const mm of MONTHS){
      const key = mkey(mm.y, mm.m);
      const tab = document.createElement("div");
      tab.className = "tab" + (state.ui.activeMonthKey===key ? " active" : "");
      tab.innerHTML = `${mm.name} <small id="cnt-${key}">0%</small>`;
      tab.addEventListener("click", ()=>{
        state.ui.activeMonthKey = key;
        saveState();
        renderAll();
      });
      monthTabsEl.appendChild(tab);
    }
  }

  // ======= Build calendar =======
  function buildMonthGrid(y,m){
    calGridEl.innerHTML = "";
    activeMonthNameEl.textContent = MONTHS.find(x=>x.y===y && x.m===m)?.name || `${y}-${m+1}`;
    const first = new Date(y,m,1);
    const startDow = first.getDay();
    const daysInMonth = new Date(y,m+1,0).getDate();

    // leading blanks
    for(let i=0;i<startDow;i++){
      const e = document.createElement("div");
      e.className="day empty";
      calGridEl.appendChild(e);
    }

    // days
    for(let d=1; d<=daysInMonth; d++){
      const ds = toDS(y,m,d);
      const L = state.logs[ds] || {};
      const expC = expectedCalories(ds);
      const expW = expectedWeightRange(ds);
      const expB = expectedBf(ds);

      const hasLog = (L.cals!=null || L.wt!=null || L.bf!=null || (L.note && L.note.trim().length));
      let cls = "day";
      if(hasLog && L.cals!=null){
        const diff = Math.abs(Number(L.cals) - expC);
        const win = Number(state.settings.adhWindow)||0;
        if(diff<=win) cls += " ontrack";
        else if(diff<=win*2) cls += " warn";
        else cls += " off";
      }

      const day = document.createElement("div");
      day.className = cls;
      day.innerHTML = `
        <div class="num">${d}</div>
        <div class="badges" id="badges-${ds}"></div>

        <div class="line">Calories: <span class="val" id="c-${ds}">${L.cals!=null ? L.cals : "-"}</span> / <span class="val" style="opacity:.85">${expC}</span></div>
        <div class="line">Weight: <span class="val" id="w-${ds}">${L.wt!=null ? fmt(L.wt,1) : "-"}</span>
          <span class="note" style="display:inline-block;margin-left:6px;opacity:.9">Expected: ${fmt(expW.lo,1)} to ${fmt(expW.hi,1)}</span>
        </div>
        <div class="line">BF%: <span class="val" id="b-${ds}">${L.bf!=null ? fmt(L.bf,1) : "-"}</span>
          <span class="note" style="display:inline-block;margin-left:6px;opacity:.9">Expected: ${fmt(expB.lo,1)} to ${fmt(expB.hi,1)}</span>
        </div>

        <div class="editRow">
          <div>
            <label style="margin-top:8px;">Log calories</label>
            <input type="number" step="1" value="${L.cals!=null?L.cals:""}" placeholder="e.g., 2200" data-ds="${ds}" data-k="cals" class="logInput"/>
          </div>
          <div>
            <label style="margin-top:8px;">Log weight</label>
            <input type="number" step="0.1" value="${L.wt!=null?L.wt:""}" placeholder="e.g., 219.8" data-ds="${ds}" data-k="wt" class="logInput"/>
          </div>
          <div>
            <label>Log BF%</label>
            <input type="number" step="0.1" value="${L.bf!=null?L.bf:""}" placeholder="e.g., 24.6" data-ds="${ds}" data-k="bf" class="logInput"/>
          </div>
          <div>
            <label>Notes</label>
            <textarea data-ds="${ds}" data-k="note" class="logNote" placeholder="Optional...">${L.note||""}</textarea>
          </div>
        </div>
      `;

      calGridEl.appendChild(day);

      // badges
      const b = day.querySelector(`#badges-${ds}`);
      if(isFastDay(ds)) b.insertAdjacentHTML("beforeend", `<span class="badge fast">FAST</span>`);
      if(isHighCarbDay(ds)) b.insertAdjacentHTML("beforeend", `<span class="badge high">High-carb</span>`);
      if(isWeighDay(ds)) b.insertAdjacentHTML("beforeend", `<span class="badge">Weigh</span>`);
    }

    // wire inputs
    document.querySelectorAll(".logInput").forEach(inp=>{
      inp.addEventListener("change", (e)=>{
        const ds = e.target.getAttribute("data-ds");
        const k = e.target.getAttribute("data-k");
        const v = e.target.value.trim();
        if(!state.logs[ds]) state.logs[ds] = {};
        state.logs[ds][k] = (v==="") ? null : Number(v);
        saveState();
        renderAll();
      });
    });

    document.querySelectorAll(".logNote").forEach(t=>{
      t.addEventListener("change", (e)=>{
        const ds = e.target.getAttribute("data-ds");
        const k = e.target.getAttribute("data-k");
        const v = e.target.value;
        if(!state.logs[ds]) state.logs[ds] = {};
        state.logs[ds][k] = v;
        saveState();
        renderAll();
      });
    });
  }

  function renderActiveMonth(){
    const parts = state.ui.activeMonthKey.split("-").map(Number);
    const y=parts[0], m=parts[1];
    buildMonthGrid(y,m);
  }

  // ======= KPIs & coach =======
  function updateKPIs(){
    const keys = Object.keys(state.logs).sort();
    let latestW=null, latestB=null;
    for(const k of keys){
      const L=state.logs[k]||{};
      if(typeof L.wt==="number") latestW=L.wt;
      if(typeof L.bf==="number") latestB=L.bf;
    }

    kpiWeight.textContent = latestW!=null ? fmt(latestW,1) : "-";
    kpiBf.textContent = latestB!=null ? fmt(latestB,1) : "-";

    // 7-day avg calories and adherence
    const now = dsToDate(todayDS());
    const last7=[];
    for(let i=0;i<7;i++){
      const d=new Date(now.getFullYear(), now.getMonth(), now.getDate()-i);
      const ds=toDS(d.getFullYear(), d.getMonth(), d.getDate());
      const L=state.logs[ds]||{};
      if(L.cals!=null) last7.push({ds, cals:Number(L.cals)});
    }
    if(last7.length){
      const avg = last7.reduce((a,x)=>a+x.cals,0)/last7.length;
      kpiCals.textContent = Math.round(avg);
      const win = Number(state.settings.adhWindow)||0;
      let ok=0;
      for(const x of last7){
        const exp=expectedCalories(x.ds);
        if(Math.abs(x.cals-exp)<=win) ok++;
      }
      kpiAdh.textContent = `${ok}/${last7.length}`;
    }else{
      kpiCals.textContent = "-";
      kpiAdh.textContent = "-";
    }

    // track pill
    const on = (kpiAdh.textContent.includes("/") && !kpiAdh.textContent.startsWith("0/"));
    trackDot.className = "dot " + (on ? "good" : "warn");
    trackText.textContent = on ? "Yes" : "—";
  }

  function updateCoach(){
    coachModeEl.textContent = state.cloud.enabled ? "Cloud + local" : "Local only";

    // next weigh-in target
    const t = dsToDate(todayDS());
    let next=null;
    for(let i=0;i<14;i++){
      const d=new Date(t.getFullYear(), t.getMonth(), t.getDate()+i);
      const ds=toDS(d.getFullYear(), d.getMonth(), d.getDate());
      if(isWeighDay(ds)){ next=ds; break; }
    }
    if(next){
      const wr = expectedWeightRange(next);
      coachTargetEl.textContent = `${fmt(wr.lo,1)}–${fmt(wr.hi,1)} lbs`;
    }else coachTargetEl.textContent = "-";

    // week 15 Thu target (approx)
    const start = dsToDate(state.settings.startDate);
    const w15Thu = new Date(start.getFullYear(), start.getMonth(), start.getDate() + (15*7) + 3);
    const ds15 = toDS(w15Thu.getFullYear(), w15Thu.getMonth(), w15Thu.getDate());
    const wr15 = expectedWeightRange(ds15);
    coachW15El.textContent = `${fmt(wr15.lo,1)}–${fmt(wr15.hi,1)} lbs`;

    coachDynEl.textContent = `Target = ${state.settings.targetCal} - (Δlbs × ${state.settings.kcalPerLb})`;
    coachActionEl.textContent = "Hit calories within window and log weigh-ins Mon/Thu";
  }

  function updateStatus(){
    statusDot.className="dot";
    statusText.textContent = "Ready";
  }

  function updateLoggedDays(){
    loggedDaysEl.textContent = computeMonthLogs();
  }

  function syncSettingsToUI(){
    const s = state.settings;
    startDateEl.value = s.startDate;
    startWeightEl.value = s.startWeight;
    startBfEl.value = s.startBf;
    targetCalEl.value = s.targetCal;
    highCalEl.value = s.highCal;
    highStartWeekEl.value = s.highStartWeek;
    secondHighStartWeekEl.value = s.secondHighStartWeek;
    kcalPerLbEl.value = s.kcalPerLb;
    minCalEl.value = s.minCal;
    adhWindowEl.value = s.adhWindow;
    primaryHighDowEl.value = String(s.primaryHighDow);
    secondHighDowEl.value = String(s.secondHighDow);
  }

  function readSettingsFromUI(){
    state.settings.startDate = startDateEl.value;
    state.settings.startWeight = Number(startWeightEl.value);
    state.settings.startBf = Number(startBfEl.value);
    state.settings.targetCal = Number(targetCalEl.value);
    state.settings.highCal = Number(highCalEl.value);
    state.settings.highStartWeek = Number(highStartWeekEl.value);
    state.settings.secondHighStartWeek = Number(secondHighStartWeekEl.value);
    state.settings.kcalPerLb = Number(kcalPerLbEl.value);
    state.settings.minCal = Number(minCalEl.value);
    state.settings.adhWindow = Number(adhWindowEl.value);
    state.settings.primaryHighDow = Number(primaryHighDowEl.value);
    state.settings.secondHighDow = Number(secondHighDowEl.value);
  }

  function renderAll(){
    renderMonthTabs();
    renderActiveMonth();
    updateLoggedDays();
    updateKPIs();
    updateCoach();
    updateStatus();
  }

  // ======= Events: settings =======
  [
    startDateEl, startWeightEl, startBfEl, targetCalEl,
    highCalEl, highStartWeekEl, secondHighStartWeekEl, kcalPerLbEl,
    minCalEl, adhWindowEl, primaryHighDowEl, secondHighDowEl
  ].forEach(el=>{
    el.addEventListener("change", ()=>{
      readSettingsFromUI();
      saveState();
      renderAll();
    });
  });

  // ======= Export / Import =======
  const filePicker = document.getElementById("filePicker");

  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="15_week_body_transformation_state.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("importBtn").addEventListener("click", ()=>{
    filePicker.accept=".json";
    filePicker.onchange = async ()=>{
      const f=filePicker.files[0]; if(!f) return;
      const txt=await f.text();
      try{
        const obj=JSON.parse(txt);
        state=obj;
        cacheStateLocally(state);
        setAuthMsg("warn","Imported state locally.");
        syncSettingsToUI();
        renderAll();
      }catch(e){
        alert("Import failed: invalid JSON");
      }
      filePicker.value="";
    };
    filePicker.click();
  });

  document.getElementById("importCsvBtn").addEventListener("click", ()=>{
    filePicker.accept=".csv";
    filePicker.onchange = async ()=>{
      const f=filePicker.files[0]; if(!f) return;
      const txt=await f.text();
      // expected columns: date,calories (header optional)
      const lines=txt.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      for(const line of lines){
        if(line.toLowerCase().includes("date") && line.toLowerCase().includes("cal")) continue;
        const parts=line.split(",");
        if(parts.length<2) continue;
        const ds=parts[0].trim();
        const cals=Number(parts[1].trim());
        if(!/^\d{4}-\d{2}-\d{2}$/.test(ds)) continue;
        if(!state.logs[ds]) state.logs[ds]={};
        if(!Number.isNaN(cals)) state.logs[ds].cals=cals;
      }
      saveState();
      renderAll();
      filePicker.value="";
    };
    filePicker.click();
  });

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(!confirm("Reset all data? This clears local logs/settings.")) return;
    state = deepClone(defaultState);
    cacheStateLocally(state);
    setAuthMsg("warn","Reset completed (local).");
    syncSettingsToUI();
    renderAll();
  });

  // ======= Cloud auth =======
  document.getElementById("signInBtn").addEventListener("click", async (e)=>{
    e.preventDefault();
    const sb = ensureSupabase();
    if(!sb){
      setAuthMsg("err","Supabase not available. Check console.");
      return;
    }

    const email = (cloudEmailEl.value||"").trim();
    const password = (cloudPassEl.value||"").trim();
    if(!email || !password){
      setAuthMsg("warn","Enter email + password.");
      return;
    }

    setAuthMsg("warn","Signing in...");
    try{
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if(error){
        console.error("signIn error:", error);
        setAuthMsg("err", error.message || "Sign-in failed.");
        return;
      }

      state.cloud.enabled = true;
      setAuthMsg("ok","Signed in. Sync enabled.");
      // try pull cloud state and merge
      const cloud = await cloudLoadState();
      if(cloud && typeof cloud === "object"){
        state = cloud;
        state.cloud = state.cloud || { enabled:true };
        state.cloud.enabled = true;
        cacheStateLocally(state);
        syncSettingsToUI();
      }else{
        // no cloud state yet, push local
        await cloudSaveState(state);
      }
      saveText.textContent = "Saved (local + cloud)";
      renderAll();
    }catch(ex){
      console.error("signIn exception:", ex);
      setAuthMsg("err","Sign-in exception. Open console.");
    }
  });

  document.getElementById("signOutBtn").addEventListener("click", async ()=>{
    const sb=ensureSupabase(); if(!sb) return;
    try{
      await sb.auth.signOut();
      state.cloud.enabled = false;
      cacheStateLocally(state);
      setAuthMsg("warn","Signed out. Local-only mode.");
      renderAll();
    }catch(e){
      console.error("signOut err:", e);
      setAuthMsg("err","Sign out failed. Open console.");
    }
  });

  // ======= Boot =======
  async function boot(){
    syncSettingsToUI();
    renderAll();

    // if already signed in from prior session, enable cloud automatically
    const sb=ensureSupabase();
    if(sb){
      const user = await getUserSafe();
      if(user){
        state.cloud.enabled = true;
        setAuthMsg("ok","Signed in. Sync enabled.");
        const cloud = await cloudLoadState();
        if(cloud && typeof cloud==="object"){
          state = cloud;
          state.cloud = state.cloud || {enabled:true};
          state.cloud.enabled = true;
          cacheStateLocally(state);
          syncSettingsToUI();
        }else{
          await cloudSaveState(state);
        }
        renderAll();
      }
    }
  }

  boot();
</script>

</body>
</html>

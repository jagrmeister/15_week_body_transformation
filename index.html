<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>15_Week_Body_Transformation</title>
<style>
  :root{
    --bg:#0b0f14;
    --bg2:#0a1220;
    --card:#101826;
    --card2:#0f1724;
    --tile:#121c2c;
    --tile2:#0f1826;

    --ink:#e9f0f7;
    --muted:#a9b6c6;

    --line:rgba(148,163,184,.18);
    --shadow:0 18px 40px rgba(0,0,0,.35);
    --shadow2:0 10px 24px rgba(0,0,0,.28);

    --accent:#3b82f6;
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;

    --fast:rgba(245,158,11,.12);
    --today:rgba(59,130,246,.14);
    --high:rgba(34,197,94,.12);

    --radius:18px;

    --tileBorder:rgba(148,163,184,.16);
    --tileBorderHover:rgba(59,130,246,.32);

    --tileMinH: 220px;
  }

  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f8fb;
      --bg2:#eef2ff;
      --card:#ffffff;
      --card2:#ffffff;
      --tile:#ffffff;
      --tile2:#f8fafc;

      --ink:#0b1e39;
      --muted:#64748b;

      --line:rgba(15,23,42,.12);
      --shadow:0 14px 28px rgba(2,8,23,.08);
      --shadow2:0 10px 20px rgba(2,8,23,.06);

      --fast:#fff7ed;
      --today:#eff6ff;
      --high:#f0fdf4;

      --tileBorder:rgba(15,23,42,.12);
      --tileBorderHover:rgba(37,99,235,.30);
    }
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--ink);
    background:
      radial-gradient(1200px 600px at 18% 0%, rgba(59,130,246,.18), transparent 60%),
      radial-gradient(1000px 560px at 92% 10%, rgba(34,197,94,.12), transparent 60%),
      linear-gradient(180deg, var(--bg2), var(--bg));
  }

  .container{max-width:1560px; margin:0 auto; padding:22px;}

  header{
    display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap;
    align-items:flex-start; margin-bottom:14px;
  }
  h1{margin:0; font-size:20px; font-weight:950;}
  .sub{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; max-width:1180px;}

  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--line);
    background:rgba(148,163,184,.10);
    color:var(--muted); font-size:12px;
  }
  .pill b{color:var(--ink)}
  .dot::before{content:""; width:8px; height:8px; border-radius:999px; background:var(--accent); display:inline-block;}
  .pill.good.dot::before{background:var(--good)}
  .pill.warn.dot::before{background:var(--warn)}
  .pill.bad.dot::before{background:var(--bad)}

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .head{
    padding:14px 16px; border-bottom:1px solid var(--line);
    display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;
    background:linear-gradient(180deg, rgba(148,163,184,.06), transparent 70%);
  }
  .head .t{font-weight:950; font-size:14px;}

  .row{display:grid; grid-template-columns: 1.25fr .95fr; gap:16px; margin-bottom:18px;}
  @media(max-width:1150px){ .row{grid-template-columns:1fr;} }

  .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; padding:16px;}
  @media(max-width:1100px){ .kpis{grid-template-columns: repeat(2,1fr);} }
  @media(max-width:620px){ .kpis{grid-template-columns: 1fr;} }

  .kpi{
    border:1px solid var(--line);
    border-radius:16px; padding:14px;
    background:linear-gradient(180deg, rgba(148,163,184,.08), transparent 75%);
    box-shadow:var(--shadow2);
  }
  .kpi .k{font-size:12px; color:var(--muted);}
  .kpi .v{margin-top:6px; font-size:20px; font-weight:950;}
  .kpi .s{margin-top:6px; font-size:12px; color:var(--muted);}

  .controls{display:grid; grid-template-columns: repeat(4,1fr); gap:10px; padding:12px 16px 16px;}
  @media(max-width:1100px){ .controls{grid-template-columns: repeat(2,1fr);} }
  @media(max-width:620px){ .controls{grid-template-columns: 1fr;} }

  label{display:block; font-size:12px; color:var(--muted); margin:0 0 4px;}
  input, select, textarea{
    width:100%; padding:10px; border-radius:12px; border:1px solid var(--line);
    background:rgba(148,163,184,.10); color:var(--ink); font-size:13px; outline:none;
  }
  select{background-color:rgba(148,163,184,.10); color:var(--ink);}
  option{background-color:var(--card); color:var(--ink);}
  textarea{min-height: 110px; resize:vertical;}

  .btnRow{display:flex; gap:10px; flex-wrap:wrap; padding:0 16px 16px;}
  .btn{
    padding:10px 14px; border-radius:12px; border:1px solid var(--line);
    cursor:pointer; font-size:13px; box-shadow:var(--shadow2);
    background:linear-gradient(180deg, rgba(59,130,246,.18), rgba(59,130,246,.06));
    color:var(--ink);
  }
  .btn.secondary{background:linear-gradient(180deg, rgba(148,163,184,.16), rgba(148,163,184,.05));}
  .btn.danger{background:linear-gradient(180deg, rgba(239,68,68,.16), rgba(239,68,68,.05));}
  .tiny{font-size:12px; color:var(--muted);}

  .tabsWrap{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    margin: 10px 0 14px;
  }
  .tabs{
    display:flex; gap:10px; flex-wrap:wrap;
    padding:10px;
    border-radius:18px;
    border:1px solid var(--line);
    background:linear-gradient(180deg, rgba(148,163,184,.10), rgba(148,163,184,.04));
    box-shadow:var(--shadow2);
  }
  .tab{
    display:inline-flex; align-items:center; gap:10px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,.22);
    background:linear-gradient(180deg, rgba(148,163,184,.10), rgba(148,163,184,.04));
    color:var(--ink);
    cursor:pointer;
    user-select:none;
    font-weight:850;
    font-size:13px;
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
  }
  .tab:hover{transform: translateY(-1px); border-color: rgba(59,130,246,.38);}
  .tab.active{
    border-color: rgba(59,130,246,.55);
    background:linear-gradient(180deg, rgba(59,130,246,.26), rgba(59,130,246,.10));
  }
  .tab .count{
    display:inline-flex; align-items:center; justify-content:center;
    min-width:26px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    color:var(--muted);
    font-weight:900;
    font-size:12px;
    background:rgba(148,163,184,.08);
  }
  .tab.active .count{border-color: rgba(59,130,246,.45); color: var(--ink);}

  .monthTitle{
    padding:14px 16px; border-bottom:1px solid var(--line);
    display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;
    background:linear-gradient(180deg, rgba(148,163,184,.08), transparent 75%);
    font-weight:950;
  }
  .calendar{
    padding:18px;
    display:grid;
    grid-template-columns: repeat(7,1fr);
    gap:14px;
  }
  @media(max-width:1100px){ .calendar{gap:12px;} }
  @media(max-width:860px){ .calendar{grid-template-columns: repeat(2,1fr);} }
  @media(max-width:520px){ .calendar{grid-template-columns: 1fr;} }

  .dow{font-size:13px; font-weight:800; color:var(--muted); padding-left:8px;}
  @media(max-width:860px){ .dow{display:none;} }

  .day{
    min-height: var(--tileMinH);
    padding:14px;
    border:1px solid var(--tileBorder);
    border-radius:16px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
      linear-gradient(180deg, var(--tile), var(--tile2));
    box-shadow:0 10px 18px rgba(2,8,23,.22);
    cursor:pointer;
    display:flex; flex-direction:column; gap:8px;
    overflow:hidden;
    transition: transform .12s ease, border-color .12s ease, filter .12s ease;
  }
  .day:hover{transform:translateY(-2px); border-color: var(--tileBorderHover); filter:saturate(1.02);}

  .day.muted{
    opacity:.35; background:transparent; box-shadow:none; cursor:default;
    border-color: rgba(148,163,184,.10);
  }
  .day.fast{
    background:
      linear-gradient(180deg, rgba(245,158,11,.16), rgba(245,158,11,.05)),
      linear-gradient(180deg, var(--tile), var(--tile2));
  }
  .day.refeed{
    background:
      linear-gradient(180deg, rgba(34,197,94,.16), rgba(34,197,94,.05)),
      linear-gradient(180deg, var(--tile), var(--tile2));
  }
  .day.reverse{
    background:
      linear-gradient(180deg, rgba(59,130,246,.18), rgba(34,197,94,.06)),
      linear-gradient(180deg, var(--tile), var(--tile2));
  }
  .day.today{
    background:
      linear-gradient(180deg, rgba(59,130,246,.18), rgba(59,130,246,.06)),
      linear-gradient(180deg, var(--tile), var(--tile2));
  }

  .topline{display:flex; justify-content:space-between; gap:8px; align-items:flex-start;}
  .num{font-weight:950; font-size:16px;}
  .badges{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;}
  .badge{
    font-size:12px; padding:4px 10px; border-radius:999px;
    border:1px solid rgba(148,163,184,.22);
    color:var(--muted);
    background:rgba(148,163,184,.10);
    white-space:nowrap;
  }
  .badge.good{color:var(--good); border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10);}
  .badge.warn{color:var(--warn); border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10);}
  .badge.bad{color:var(--bad); border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10);}

  .line{font-size:14px; color:var(--muted); line-height:1.25;}
  .line b{color:var(--ink); font-weight:900;}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}

  .modal{position:fixed; inset:0; background:rgba(2,6,23,.62); display:none; align-items:center; justify-content:center; padding:24px; z-index:50;}
  .modal.open{display:flex;}
  .panel{width:min(980px,100%); background:var(--card); border:1px solid var(--line); border-radius:20px; box-shadow:var(--shadow); overflow:hidden;}
  .panelHead{padding:14px 16px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start;}
  .panelHead .t1{font-weight:950; font-size:14px;}
  .panelHead .t2{margin-top:4px; color:var(--muted); font-size:12px;}
  .panelBody{padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:14px;}
  @media(max-width:900px){ .panelBody{grid-template-columns:1fr;} }
  .box{border:1px solid var(--line); border-radius:18px; padding:14px; background:linear-gradient(180deg, rgba(148,163,184,.08), rgba(148,163,184,.03));}
  .box h3{margin:0 0 10px; font-size:13px; font-weight:950;}
  .panelFoot{
    padding:12px 16px; border-top:1px solid var(--line);
    background:rgba(148,163,184,.06);
    display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;
  }

  /* Coach KPI formatting */
  .coach-date{font-size:12px; color:var(--muted); margin-bottom:4px;}
  .coach-metric{font-size:15px; line-height:1.35;}
  .coach-metric .label{color:var(--muted); margin-right:6px; font-weight:650;}
  .coach-metric strong{font-weight:950; font-size:18px;}
  .coach-sub{font-size:12px; color:var(--muted); margin-top:2px;}

  @media(max-width:620px){
    .tabs{flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch;}
    .tabs::-webkit-scrollbar{height:8px;}
    .tab{flex:0 0 auto;}
    .calendar{padding:12px; gap:10px;}
    .day{padding:12px;}
    .kpi .v{font-size:18px;}
    h1{font-size:22px;}
  }


  .spark{
    margin-top:10px;
    width:100%;
    min-height:110px;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(15,23,42,.22), rgba(15,23,42,.10));
    border:1px solid var(--line);
    display:flex;
    align-items:stretch;
    justify-content:stretch;
    overflow:hidden;
    padding:6px;
  }
  .spark svg{ width:100%; height:100%; display:block; }
  .spark .axisText{ fill:rgba(169,182,198,.92); font-size:10px; }
  .spark .axisLine{ stroke:rgba(148,163,184,.22); stroke-width:1; }
  .spark .gridLine{ stroke:rgba(148,163,184,.14); stroke-width:1; }
  .spark .legendText{ fill:rgba(169,182,198,.92); font-size:10px; }
  .spark .titleText{ fill:rgba(233,240,247,.92); font-size:10px; font-weight:600; }
  .miniTable{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    background:rgba(15,23,42,.12);
  }
  .miniRow{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:10px;
    padding:8px 10px;
    border-top:1px solid var(--line);
    font-size:12px;
    color:var(--muted);
  }
  .miniRow:first-child{ border-top:none; font-weight:800; color:var(--ink); background:rgba(255,255,255,.03); }
  .miniRow b{ color:var(--ink); }

</style>
</head>

<body>
<div class="container">
  <header>
    <div>
      <h1>15_Week_Body_Transformation (Jan to May 2026)</h1>
      <div class="sub">
        Fast highlighted: <span class="mono">2026-01-02</span> to <span class="mono">2026-01-03</span> only.
        <b>Jan 4 is a standard day</b> (not fasting).
        High-carb schedule: <b>Week 3+</b> Sundays, and <b>Week 10+</b> Sundays + Wednesdays.
        Dynamic calories adjust automatically as your weight drops (BMR adjustment).
        Reverse diet is built in for <b>Apr 20 through May 14</b> to ramp toward <b>2700</b>.
      </div>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <div class="pill dot" id="statusPill"><b>Status:</b> -</div>
      <div class="pill dot good" id="savePill"><b>Data:</b> Saved locally</div>
    </div>
  </header>

  <section class="card" id="cloudCard" style="margin-bottom:18px;">
    <div class="head">
      <div class="t">Cloud Sync</div>
      <div class="pill dot" id="cloudPill"><b>Cloud:</b> Not signed in</div>
    </div>
    <div class="tiny" style="padding:0 16px 10px;">
      Use this to sync your tracker across devices. Calendar rendering does not depend on cloud sync.
    </div>
    <div class="controls" style="padding-top:0;">
      <div>
        <label>Cloud sync email</label>
        <input id="authEmail" type="email" placeholder="you@email.com"/>
      </div>
      <div>
        <label>Cloud sync password</label>
        <input id="authPass" type="password" placeholder="password"/>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn secondary" id="signInBtn" type="button">Sign In (Enable Sync)</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn secondary" id="signOutBtn" type="button">Sign Out</button>
      </div>
    </div>
    <div class="tiny" id="authHint" style="padding:0 16px 16px; opacity:.8;">
      Tip: Create the user in Supabase Authentication → Users. Disable email confirmation while testing.
    </div>
  </section>


  <section class="card" style="margin-bottom:18px;">
    <div class="head">
      <div class="t">Coach Suggestions</div>
      <div class="pill dot" id="coachPill"><b>Guidance:</b> -</div>
    </div>
    <div class="kpis">
      <div class="kpi">
        <div class="k">Primary action</div>
        <div class="v" id="coachPrimary">-</div>
        <div class="s">Based on adherence and weigh-in trend</div>
      </div>
      <div class="kpi">
        <div class="k">Next weigh-in target</div>
        <div class="v" id="coachNextTarget">-</div>
        <div class="s">Shown on upcoming Mon or Thu</div>
      </div>
      <div class="kpi">
        <div class="k">Week 15 Thursday target</div>
        <div class="v" id="coachWeek15">-</div>
        <div class="s">End-of-block expectation</div>
      </div>
      <div class="kpi">
        <div class="k">Dynamic calorie logic</div>
        <div class="v" id="coachDyn">-</div>
        <div class="s">Uses your latest logged weight</div>
      </div>
    </div>
  </section>

  
  <section class="card" style="margin-bottom:18px;">
    <div class="head">
      <div class="t">Snapshot</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="pill dot" id="dietPill"><b>Diet:</b> -</div>
        <div class="pill dot" id="onTrackPill"><b>On track:</b> -</div>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi">
        <div class="k">Start weight (official)</div>
        <div class="v" id="kpiStartW">-</div>
        <div class="s">Baseline for deltas</div>
      </div>
      <div class="kpi">
        <div class="k">Start BF% (official)</div>
        <div class="v" id="kpiStartBf">-</div>
        <div class="s">Baseline for deltas</div>
      </div>
      <div class="kpi">
        <div class="k">Current weight (latest)</div>
        <div class="v" id="kpiCurrent">-</div>
        <div class="s" id="kpiDeltaW">Change since start: -</div>
      </div>
      <div class="kpi">
        <div class="k">Current BF% (latest)</div>
        <div class="v" id="kpiCurrentBf">-</div>
        <div class="s" id="kpiDeltaBf">Change since start: -</div>
      </div>
      <div class="kpi">
        <div class="k">7-day avg calories</div>
        <div class="v" id="kpiAvgCal">-</div>
        <div class="s">From logged calories</div>
      </div>
      <div class="kpi">
        <div class="k">7-day adherence</div>
        <div class="v" id="kpiAdh">-</div>
        <div class="s">Within ± window</div>
      </div>
      <div class="kpi">
        <div class="k">7-day avg sleep</div>
        <div class="v" id="kpiAvgSleep">-</div>
        <div class="s">From logged sleep</div>
      </div>
      <div class="kpi">
        <div class="k">7-day avg protein</div>
        <div class="v" id="kpiAvgProtein">-</div>
        <div class="s">From logged macros</div>
      </div>
      <div class="kpi">
        <div class="k">7-day avg carbs</div>
        <div class="v" id="kpiAvgCarbs">-</div>
        <div class="s">From logged macros</div>
      </div>
      <div class="kpi">
        <div class="k">7-day avg fat</div>
        <div class="v" id="kpiAvgFat">-</div>
        <div class="s">From logged macros</div>
      </div>

    </div>
  </section>

  
  <section class="card" style="margin-bottom:18px;">
    <div class="head">
      <div class="t">Trends & Insights</div>
      <div class="pill dot" id="insightsPill"><b>Insights:</b> -</div>
    </div>
    <div class="kpis">
      <div class="kpi">
        <div class="k">Weight trend (21 days)</div>
        <div class="spark" id="sparkWeight">-</div>
        <div class="s" id="sparkWeightNote">-</div>
      </div>
      <div class="kpi">
        <div class="k">Calories vs target (14 days)</div>
        <div class="spark" id="sparkCalories">-</div>
        <div class="s" id="sparkCaloriesNote">-</div>
      </div>
      <div class="kpi">
        <div class="k">Sleep (14 days)</div>
        <div class="spark" id="sparkSleep">-</div>
        <div class="s" id="sparkSleepNote">-</div>
      </div>
      <div class="kpi">
        <div class="k">Weekday consistency (8 weeks)</div>
        <div class="miniTable" id="weekdayTable">-</div>
        <div class="s">Best and worst weekdays update as you log more data.</div>
      </div>
    </div>
  </section>

<section class="card" style="margin-bottom:18px;">
    <div class="head">
      <div class="t">Advanced Settings</div>
      <div class="pill dot warn" id="advancedPill"><b>Advanced:</b> Hidden</div>
    </div>

    <details id="advancedDetails" style="padding:0 16px 16px;">
      <summary style="cursor:pointer; user-select:none; padding:10px 0; font-weight:700;">
        Show advanced controls
        <span class="tiny" style="font-weight:500; opacity:.75;">(mostly read-only)</span>
      </summary>

      <div class="controls" style="padding-top:10px;">
        <div>
          <label>Official start weigh-in date (Mon)</label>
          <input type="date" id="startDate" value="2026-01-05"/>
        </div>
        <div>
          <label>Official start weight (lbs)</label>
          <input type="number" id="startWeight" step="0.1" value="221.6"/>
        </div>
        <div>
          <label>Official start body fat (%)</label>
          <input type="number" id="startBf" step="0.1" value="26.0"/>
        </div>
        <div>
          <label>Base target calories (normal)</label>
          <input type="number" id="targetCal" step="10" value="2200" disabled/>
        </div>
      </div>

      <div class="controls" style="padding-top:0;">
        <div>
          <label>High-carb day calories</label>
          <input type="number" id="highCal" step="10" value="2400" disabled/>
        </div>
        <div>
          <label>High-carb starts (week #)</label>
          <input type="number" id="highStartWeek" min="1" step="1" value="3" disabled/>
        </div>
        <div>
          <label>Second high-carb starts (week #)</label>
          <input type="number" id="secondHighStartWeek" min="1" step="1" value="10" disabled/>
        </div>
        <div>
          <label>BMR adjust (kcal per lb change)</label>
          <input type="number" id="kcalPerLb" min="0" step="1" value="10" disabled/>
        </div>
      </div>

      <div class="controls" style="padding-top:0;">
        <div>
          <label>Minimum calories floor</label>
          <input type="number" id="minCal" min="0" step="10" value="1700" disabled/>
        </div>
        <div>
          <label>Adherence window (kcal)</label>
          <input type="number" id="adhWindow" step="10" value="150" disabled/>
        </div>
        <div>
          <label>Sleep target (hours)</label>
          <input type="number" id="sleepTarget" step="0.1" min="0" value="7.0"/>
        </div>
        <div>
          <label>Protein target (g)</label>
          <input type="number" id="proteinTarget" step="1" min="0" value="220"/>
        </div>
        <div>
          <label>Carb target (g)</label>
          <input type="number" id="carbTarget" step="1" min="0" value="100"/>
        </div>
        <div>
          <label>Fat target (g)</label>
          <input type="number" id="fatTarget" step="1" min="0" value="90"/>

        </div>
        <div>
          <label>Primary high-carb day</label>
          <select id="primaryHighDow" disabled>
            <option value="0" selected>Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3">Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
          </select>
        </div>
        <div>
          <label>Second high-carb day (week 10+)</label>
          <select id="secondHighDow" disabled>
            <option value="0">Sunday</option>
            <option value="1">Monday</option>
            <option value="2">Tuesday</option>
            <option value="3" selected>Wednesday</option>
            <option value="4">Thursday</option>
            <option value="5">Friday</option>
            <option value="6">Saturday</option>
          </select>
        </div>
      </div>

      <div class="btnRow" style="justify-content:flex-end;">
        <button class="btn danger" id="resetBtn" type="button">Reset All Data</button>
      </div>
      <div class="tiny" style="opacity:.85; padding-bottom:8px;">
        Reset is intentionally tucked away. Consider signing in first so you can restore from cloud if needed.
      </div>

      <!-- Keep these hidden IDs to avoid JS null errors -->
      <button class="btn secondary" id="importCaloriesBtn" style="display:none" type="button">Import Calories CSV</button>
      <button class="btn secondary" id="exportBtn" style="display:none" type="button">Export JSON</button>
      <button class="btn secondary" id="importBtn" style="display:none" type="button">Import JSON</button>
    </details>
  </section>

  <div class="tabsWrap">

    <div class="tabs" id="monthTabs"></div>
    <div class="pill dot" id="activeMonthPill"><b>Month:</b> -</div>
  </div>

  <section class="card" id="monthCard">
    <div class="monthTitle">
      <div id="monthTitleText">-</div>
      <div class="pill dot" id="monthLoggedPill"><b>Logged days:</b> -</div>
    </div>
    <div class="calendar" id="monthGrid"></div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="panel">
    <div class="panelHead">
      <div>
        <div class="t1" id="modalTitle">Day</div>
        <div class="t2" id="modalSub">Calories + workout + weigh-in (Mon/Thu)</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="pill dot" id="tagPill"><b>Target:</b> -</div>
        <div class="pill dot warn" id="saveIndicator"><b>Saved:</b> -</div>
        <button class="btn secondary" id="closeBtn">Close</button>
      </div>
    </div>

    <div class="panelBody">
      <div class="box">
        <h3>Plan</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div>
            <label>Target calories for this day</label>
            <input id="dayTarget" type="number" disabled/>
          </div>
          <div>
            <label>Expected weight (if weigh-in day)</label>
            <input id="expectedWeight" type="text" disabled placeholder="-"/>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div>
            <label>Expected BF% range (if weigh-in day)</label>
            <input id="expectedBf" type="text" disabled placeholder="-"/>
          </div>
          <div>
            <label>Lean mass baseline (est.)</label>
            <input id="lbmBase" type="text" disabled placeholder="-"/>
          </div>
        </div>

        <div class="tiny" style="margin-top:10px;">
          Targets include dynamic BMR adjustment based on latest logged weight before this date.
          Reverse diet targets override the cut targets in the reverse window.
        </div>
      </div>

      <div class="box">
        <h3>Actuals</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div>
            <label>Calories eaten</label>
            <input id="calories" type="number" step="10" placeholder="e.g., 2200"/>
          </div>
          <div>
            <label>Workout</label>
            <select id="workout">
              <option value="">Not logged</option>
              <option value="strength">Strength Training</option>
              <option value="hiit">HIIT</option>
              <option value="walk">Walk</option>
              <option value="rest">Rest Day</option>
            </select>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div>
            <label>Scale weight (lbs)</label>
            <input id="weight" type="number" step="0.1" placeholder="Mon/Thu"/>
          </div>
          <div>
            <label>Body fat % (Fitdays)</label>
            <input id="bf" type="number" step="0.1" placeholder="Mon/Thu optional"/>
          </div>
        </div>

        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div>
            <label>Protein (g)</label>
            <input id="protein" type="number" step="1" min="0" placeholder="e.g., 220"/>
          </div>
          <div>
            <label>Carbs (g)</label>
            <input id="carbs" type="number" step="1" min="0" placeholder="e.g., 90"/>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div>
            <label>Fat (g)</label>
            <input id="fat" type="number" step="1" min="0" placeholder="e.g., 85"/>
          </div>
          <div>
            <label>Fiber (g) (optional)</label>
            <input id="fiber" type="number" step="1" min="0" placeholder="e.g., 25"/>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div>
            <label>Sleep (hours)</label>
            <input id="sleepHours" type="number" step="0.1" min="0" max="24" placeholder="e.g., 7.5"/>
          </div>
          <div>
            <label>Sleep quality (1–5)</label>
            <select id="sleepQuality">
              <option value=""></option>
              <option value="1">1 (rough)</option>
              <option value="2">2</option>
              <option value="3">3 (ok)</option>
              <option value="4">4</option>
              <option value="5">5 (great)</option>
            </select>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
          <div>
            <label>Bedtime</label>
            <input id="bedtime" type="time"/>
          </div>
          <div>
            <label>Wake time</label>
            <input id="waketime" type="time"/>
          </div>
        </div>


        <div style="display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;">
          <div>
            <label>Notes</label>
            <textarea id="notes" placeholder="Sleep, stress, sodium, alcohol, steps, etc."></textarea>
          </div>
        </div>

        <div class="tiny" id="vsExpectedNote" style="margin-top:10px;">-</div>
      </div>
    </div>

    <div class="panelFoot">
      <div class="tiny">Autosave is on.</div>
      <button class="btn secondary" id="clearDayBtn">Clear this day</button>
    </div>
  </div>
</div>

<!-- Correct Supabase JS library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

  // ===== Runtime error banner (so failures are visible even on iPhone) =====
  (function(){
    const show = (msg) => {
      try{
        let bar = document.getElementById("errorBar");
        if(!bar){
          bar = document.createElement("div");
          bar.id="errorBar";
          bar.style.cssText="position:sticky;top:0;z-index:99999;padding:10px 12px;background:rgba(160,0,0,.92);color:#fff;font:14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;box-shadow:0 6px 24px rgba(0,0,0,.35)";
          bar.innerHTML = "<b>Script error:</b> <span id='errorBarMsg'></span>";
          document.body.prepend(bar);
        }
        const t = document.getElementById("errorBarMsg");
        if(t) t.textContent = msg;
      }catch(_){}
    };
    window.addEventListener("error", (e)=> show(e.message || String(e.error||e)));
    window.addEventListener("unhandledrejection", (e)=> show((e.reason && (e.reason.message||String(e.reason))) || "Unhandled promise rejection"));
  })();

  document.addEventListener("DOMContentLoaded", () => {

  function ymd(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const da=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function parseYMD(s){
    const [y,m,d]=s.split('-').map(Number);
    return new Date(y, m-1, d);
  }

  function fmtUSDate(ymdStr){
    // ymdStr format: YYYY-MM-DD
    const d = parseYMD(ymdStr);
    return d.toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"});
  }

  function addDays(d, n){
    const x=new Date(d);
    x.setDate(x.getDate()+n);
    return x;
  }
  function weekdayName(d){ return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]; }

  const STORAGE_KEY = "diet_15wk_body_transformation_v5";
  const LOCAL_CACHE_KEY = "diet_15wk_cache_v1";

  // Fast window: Jan 2 to Jan 3 only (Jan 4 is normal)
  const FAST_START = "2026-01-02";
  const FAST_END   = "2026-01-03";

  // Reverse diet window: last 2 weeks of April + first 2 weeks of May
  const REVERSE_START = "2026-04-20";
  const REVERSE_END   = "2026-05-14";
  const REVERSE_TARGET = 2700;

  // No special targets
  const SPECIAL_TARGETS = {};

  const THU_WEEK_RANGES = [
    {low:219.7, high:220.7},
    {low:218.0, high:219.0},
    {low:216.8, high:217.8},
    {low:215.6, high:216.6},
    {low:214.4, high:215.4},
    {low:213.2, high:214.2},
    {low:212.0, high:213.0},
    {low:210.7, high:211.7},
    {low:212.2, high:214.2},
    {low:209.1, high:210.6},
    {low:207.9, high:209.4},
    {low:206.7, high:208.2},
    {low:205.6, high:207.1},
    {low:204.4, high:205.9},
    {low:203.3, high:204.8}
  ];

  function isFastDay(ds){ return ds>=FAST_START && ds<=FAST_END; }
  function inReverseWindow(ds){ return ds>=REVERSE_START && ds<=REVERSE_END; }

  // Supabase
  const SUPABASE_URL = "https://dklnhdjxplpqnrjziqkq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrbG5oZGp4cGxwcW5yanppcWtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MzkxNjAsImV4cCI6MjA4MzExNTE2MH0.qp0eOggU4nrhgjj-yrUmhvHNRz1uL8TSp9xrDsAq5Sg";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function getUser() {
    const { data } = await supabase.auth.getUser();
    return data.user || null;
  }

  async function cloudLoadState() {
    const user = await getUser();
    if (!user) return null;

    const { data, error } = await supabase
      .from("tracker_states")
      .select("state")
      .eq("user_id", user.id)
      .single();

    if (error && error.code !== "PGRST116") {
      console.error("cloudLoadState error:", error);
      return null;
    }
    return data?.state || null;
  }

  async function cloudSaveState(newState) {
    const user = await getUser();
    if (!user) return false;

    const payload = {
      user_id: user.id,
      state: newState,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabase
      .from("tracker_states")
      .upsert(payload, { onConflict: "user_id" });

    if (error) {
      console.error("cloudSaveState error:", error);
      return false;
    }
    return true;
  }

  function cacheStateLocally(newState) {
    try { localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify(newState)); } catch {}
  }

  function loadLocalCache() {
    try {
      const raw = localStorage.getItem(LOCAL_CACHE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {
        days:{},
        settings:{
          startDate:"2026-01-05",
          startWeight:221.6,
          startBf:25.0,
          targetCal:2200,
          highCal:2400,
          highStartWeek:3,
          secondHighStartWeek:10,
          primaryHighDow:0,
          secondHighDow:3,
          adhWindow:150,
          kcalPerLb:10,
          minCal:1700
        },
        ui:{ activeMonthKey:"2026-0" }
      };

      const s = JSON.parse(raw);
      if(!s.days) s.days = {};
      if(!s.settings) s.settings = {};
      if(!s.ui) s.ui = {};

      const defSettings = {
        startDate:"2026-01-05",
        startWeight:221.6,
        startBf:25.0,
        targetCal:2200,
        highCal:2400,
        highStartWeek:3,
        secondHighStartWeek:10,
        primaryHighDow:0,
        secondHighDow:3,
        adhWindow:150,
        kcalPerLb:10,
        minCal:1700,
        sleepTarget:7.0,
        proteinTarget:220,
        carbTarget:100,
        fatTarget:90
      };
      s.settings = {...defSettings, ...s.settings};

      const defUi = { activeMonthKey:"2026-0" };
      s.ui = {...defUi, ...s.ui};

      return s;
    }catch(e){
      return {
        days:{},
        settings:{
          startDate:"2026-01-05",
          startWeight:221.6,
          startBf:25.0,
          targetCal:2200,
          highCal:2400,
          highStartWeek:3,
          secondHighStartWeek:10,
          primaryHighDow:0,
          secondHighDow:3,
          adhWindow:150,
          kcalPerLb:10,
          minCal:1700
        },
        ui:{ activeMonthKey:"2026-0" }
      };
    }
  }

  let state = loadState(); // local fallback

  const savePill = document.getElementById("savePill");
  function pulseSaved(){
    savePill.innerHTML = "<b>Data:</b> Saved locally";
    savePill.classList.remove("good","warn","bad");
    savePill.classList.add("good");
    savePill.style.transform="scale(1.01)";
    setTimeout(()=>{ savePill.style.transform=""; }, 140);
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    cacheStateLocally(state);
    try { cloudSaveState(state); } catch {}
    pulseSaved();
  }

  // Settings elements
  const startDateEl = document.getElementById("startDate");
  const startWeightEl = document.getElementById("startWeight");
  const startBfEl = document.getElementById("startBf");
  const targetCalEl   = document.getElementById("targetCal");
  const highCalEl     = document.getElementById("highCal");
  const highStartWeekEl = document.getElementById("highStartWeek");
  const secondHighStartWeekEl = document.getElementById("secondHighStartWeek");
  const kcalPerLbEl   = document.getElementById("kcalPerLb");
  const minCalEl      = document.getElementById("minCal");
  const adhWindowEl   = document.getElementById("adhWindow");
  const sleepTargetEl = document.getElementById("sleepTarget");
  const proteinTargetEl = document.getElementById("proteinTarget");
  const carbTargetEl = document.getElementById("carbTarget");
  const fatTargetEl = document.getElementById("fatTarget");
  const primaryHighDowEl = document.getElementById("primaryHighDow");
  const secondHighDowEl  = document.getElementById("secondHighDow");

  // Advanced settings toggle pill
  const advancedDetailsEl = document.getElementById("advancedDetails");
  const advancedPillEl = document.getElementById("advancedPill");
  if(advancedDetailsEl && advancedPillEl){
    const syncAdvPill = ()=>{
      if(advancedDetailsEl.open){
        advancedPillEl.classList.remove("warn");
        advancedPillEl.classList.add("good");
        advancedPillEl.innerHTML = "<b>Advanced:</b> Visible";
      }else{
        advancedPillEl.classList.remove("good");
        advancedPillEl.classList.add("warn");
        advancedPillEl.innerHTML = "<b>Advanced:</b> Hidden";
      }
    };
    advancedDetailsEl.addEventListener("toggle", syncAdvPill);
    syncAdvPill();
  }


  function syncSettingsToUI(){
    startDateEl.value  = state.settings.startDate;
    startWeightEl.value= state.settings.startWeight;
    startBfEl.value    = state.settings.startBf;
    targetCalEl.value  = state.settings.targetCal;
    highCalEl.value    = state.settings.highCal;
    highStartWeekEl.value = state.settings.highStartWeek;
    secondHighStartWeekEl.value = state.settings.secondHighStartWeek;
    kcalPerLbEl.value  = state.settings.kcalPerLb;
    minCalEl.value     = state.settings.minCal;
    adhWindowEl.value  = state.settings.adhWindow;
    if(sleepTargetEl) sleepTargetEl.value = state.settings.sleepTarget;
    if(proteinTargetEl) proteinTargetEl.value = state.settings.proteinTarget;
    if(carbTargetEl) carbTargetEl.value = state.settings.carbTarget;
    if(fatTargetEl) fatTargetEl.value = state.settings.fatTarget;
    primaryHighDowEl.value = String(state.settings.primaryHighDow);
    secondHighDowEl.value  = String(state.settings.secondHighDow);
  }


  function wireSettings(){
    const pairs = [
      [startDateEl, v=>String(v||"")],
      [startWeightEl, v=>Number(v)],
      [startBfEl, v=>Number(v)],
      [targetCalEl, v=>Number(v)],
      [highCalEl, v=>Number(v)],
      [highStartWeekEl, v=>Number(v)],
      [secondHighStartWeekEl, v=>Number(v)],
      [kcalPerLbEl, v=>Number(v)],
      [minCalEl, v=>Number(v)],
      [adhWindowEl, v=>Number(v)],
      [sleepTargetEl, v=>Number(v)],
      [proteinTargetEl, v=>Number(v)],
      [carbTargetEl, v=>Number(v)],
      [fatTargetEl, v=>Number(v)],
      [primaryHighDowEl, v=>Number(v)],
      [secondHighDowEl, v=>Number(v)]
    ];

    const apply = ()=>{
      // Some fields are intentionally disabled; ignore them.
      try{
        const s = state.settings;
        if(startDateEl && startDateEl.value) s.startDate = startDateEl.value;
        if(startWeightEl && startWeightEl.value!=="") s.startWeight = Number(startWeightEl.value);
        if(startBfEl && startBfEl.value!=="") s.startBf = Number(startBfEl.value);

        if(targetCalEl && !targetCalEl.disabled && targetCalEl.value!=="") s.targetCal = Number(targetCalEl.value);
        if(highCalEl && !highCalEl.disabled && highCalEl.value!=="") s.highCal = Number(highCalEl.value);
        if(highStartWeekEl && !highStartWeekEl.disabled && highStartWeekEl.value!=="") s.highStartWeek = Number(highStartWeekEl.value);
        if(secondHighStartWeekEl && !secondHighStartWeekEl.disabled && secondHighStartWeekEl.value!=="") s.secondHighStartWeek = Number(secondHighStartWeekEl.value);
        if(kcalPerLbEl && !kcalPerLbEl.disabled && kcalPerLbEl.value!=="") s.kcalPerLb = Number(kcalPerLbEl.value);

        if(sleepTargetEl && sleepTargetEl.value!=="") s.sleepTarget = Math.max(0, Number(sleepTargetEl.value));
        if(proteinTargetEl && proteinTargetEl.value!=="") s.proteinTarget = Math.max(0, Number(proteinTargetEl.value));
        if(carbTargetEl && carbTargetEl.value!=="") s.carbTarget = Math.max(0, Number(carbTargetEl.value));
        if(fatTargetEl && fatTargetEl.value!=="") s.fatTarget = Math.max(0, Number(fatTargetEl.value));

        saveState();
        renderAll();
      }catch{}
    };

    const els = [startDateEl,startWeightEl,startBfEl,targetCalEl,highCalEl,highStartWeekEl,secondHighStartWeekEl,kcalPerLbEl,minCalEl,adhWindowEl,
                 sleepTargetEl,proteinTargetEl,carbTargetEl,fatTargetEl,primaryHighDowEl,secondHighDowEl].filter(Boolean);
    els.forEach(el=>{
      el.addEventListener("change", apply);
      el.addEventListener("input", ()=>{ /* avoid chatty on every keypress for dates */ if(el.type==="number") apply(); });
    });
  }


  // ===== Local login lockout (UX + basic abuse reduction) =====
  // Note: This is enforced in the browser (localStorage). It improves UX and discourages casual brute force,
  // but it does NOT prevent direct calls to Supabase Auth endpoints. For stronger protection, add server-side
  // rate limiting / WAF and consider CAPTCHA on auth.
  const AUTH_GUARD_KEY = "supabase_auth_guard_v1";
  const AUTH_MAX_FAILS = 5;
  const AUTH_LOCKOUT_MS = 3 * 60 * 60 * 1000; // 3 hours

  function _authGuardLoad(){
    try { return JSON.parse(localStorage.getItem(AUTH_GUARD_KEY) || "{}"); } catch { return {}; }
  }
  function _authGuardSave(obj){
    try { localStorage.setItem(AUTH_GUARD_KEY, JSON.stringify(obj)); } catch {}
  }
  function authGetLock(email){
    const key = (email || "").trim().toLowerCase();
    const all = _authGuardLoad();
    const rec = all[key] || { fails: 0, lockoutUntil: 0 };
    return { key, all, rec };
  }
  function authSetLock(email, fails, lockoutUntil){
    const { key, all } = authGetLock(email);
    all[key] = { fails, lockoutUntil };
    _authGuardSave(all);
  }
  function authClearLock(email){
    const { key, all } = authGetLock(email);
    delete all[key];
    _authGuardSave(all);
  }
  function authIsLocked(email){
    const { rec } = authGetLock(email);
    const now = Date.now();
    return rec.lockoutUntil && now < rec.lockoutUntil ? rec.lockoutUntil : 0;
  }
  function authLockMsg(untilMs){
    const mins = Math.ceil((untilMs - Date.now()) / 60000);
    const hrs = Math.floor(mins / 60);
    const remM = mins % 60;
    if(hrs <= 0) return `Locked out. Try again in ${mins} minute(s).`;
    return `Locked out. Try again in ${hrs}h ${remM}m.`;
  }

  // Auth button wiring
  document.getElementById("signInBtn").addEventListener("click", async () => {
    const email = document.getElementById("authEmail").value.trim();
    const pass = document.getElementById("authPass").value;

    if(!email || !pass){
      alert("Enter email and password.");
      return;
    }

    // Enforce local lockout after repeated failures (per email, per device/browser)
    const lockedUntil = authIsLocked(email);
    if(lockedUntil){
      const msg = authLockMsg(lockedUntil);
      alert(msg);
      const cloudPillEl = document.getElementById("cloudPill");
      if(cloudPillEl){
        cloudPillEl.classList.remove("good","warn");
        cloudPillEl.classList.add("bad");
        cloudPillEl.innerHTML = `<b>Cloud:</b> Locked out (${email})`;
      }
      return;
    }

    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });

    if (error) {
      const { rec } = authGetLock(email);
      const fails = (rec.fails || 0) + 1;

      if (fails >= AUTH_MAX_FAILS) {
        const until = Date.now() + AUTH_LOCKOUT_MS;
        authSetLock(email, fails, until);
        alert(`Too many failed attempts. ${authLockMsg(until)}`);
        const cloudPillEl = document.getElementById("cloudPill");
        if(cloudPillEl){
          cloudPillEl.classList.remove("good","warn");
          cloudPillEl.classList.add("bad");
          cloudPillEl.innerHTML = `<b>Cloud:</b> Locked out (${email})`;
        }
      } else {
        authSetLock(email, fails, 0);
        const remaining = AUTH_MAX_FAILS - fails;
        alert(`${error.message}

Attempts remaining before lockout: ${remaining}`);
        const cloudPillEl = document.getElementById("cloudPill");
        if(cloudPillEl){
          cloudPillEl.classList.remove("good","bad");
          cloudPillEl.classList.add("warn");
          cloudPillEl.innerHTML = `<b>Cloud:</b> Sign-in failed (${remaining} left)`;
        }
      }
      return;
    }

    // Success: clear lock record for this email
    authClearLock(email);

    const cloud = await cloudLoadState();
    if (cloud) state = cloud;

    cacheStateLocally(state);
    syncSettingsToUI();
    wireSettings();
    renderAll();

    const cloudPillEl = document.getElementById("cloudPill");
    if(cloudPillEl){
      cloudPillEl.classList.remove("warn","bad");
      cloudPillEl.classList.add("good");
      cloudPillEl.innerHTML = `<b>Cloud:</b> Signed in (${email})`;
    }
  });

  document.getElementById("signOutBtn").addEventListener("click", async () => {
    await supabase.auth.signOut();
    const cloudPillEl = document.getElementById("cloudPill");
    if(cloudPillEl){
      cloudPillEl.classList.remove("good","bad");
      cloudPillEl.classList.add("warn");
      cloudPillEl.innerHTML = "<b>Cloud:</b> Not signed in";
    }
  });

  // App init (single render path)
  async function initApp() {
    const cached = loadLocalCache();
    if (cached) state = cached;

    try {
      const user = await getUser();
      if (user) {
        const cloud = await cloudLoadState();
        if (cloud) state = cloud;
      }
    } catch (e) {
      console.warn("Cloud init skipped:", e);
    }

    cacheStateLocally(state);
    syncSettingsToUI();
    wireSettings();
    renderAll();
  }

  function clamp(n, lo, hi){
    if(n < lo) return lo;
    if(hi !== null && n > hi) return hi;
    return n;
  }
  function isWeighDay(d){
    const dow = d.getDay();
    return dow===1 || dow===4;
  }
  function weekIndexForDate(ds){
    const start = parseYMD(state.settings.startDate);
    const d = parseYMD(ds);
    const diffDays = Math.floor((d - start) / (1000*60*60*24));
    if(diffDays < 0) return null;
    return Math.floor(diffDays / 7) + 1;
  }
  function isThursdayOfWeek(ds){
    const wi = weekIndexForDate(ds);
    if(!wi || wi<1 || wi>15) return false;
    const start = parseYMD(state.settings.startDate);
    const thu = addDays(start, (wi-1)*7 + 3);
    return ymd(thu) === ds;
  }

  function expectedRange(ds){
    const d = parseYMD(ds);
    if(!isWeighDay(d)) return null;

    const startDate = state.settings.startDate;
    if(ds === startDate){
      const sw = Number(state.settings.startWeight);
      return {low: sw-0.5, high: sw+0.5, kind:"baseline"};
    }

    const wi = weekIndexForDate(ds);
    if(!wi || wi<1 || wi>15) return null;

    if(isThursdayOfWeek(ds)){
      const r = THU_WEEK_RANGES[wi-1];
      return {low:r.low, high:r.high, kind:"thu"};
    }

    if(d.getDay() === 1){
      if(wi === 1) return null;
      const prev = THU_WEEK_RANGES[wi-2];
      const next = THU_WEEK_RANGES[wi-1];
      const t = 4/7;
      return {
        low:  prev.low  + (next.low  - prev.low)  * t,
        high: prev.high + (next.high - prev.high) * t,
        kind:"mon"
      };
    }
    return null;
  }

  function fmtRange(r){
    if(!r) return "";
    return `${r.low.toFixed(1)} to ${r.high.toFixed(1)}`;
  }

  function getWeightBefore(ds){
    const target = parseYMD(ds);
    let best = null;
    for(const k in state.days){
      const rec = state.days[k];
      if(rec && rec.weight!==null && rec.weight!==undefined){
        const kd = parseYMD(k);
        if(kd <= target){
          if(!best || kd > best.d) best = {d: kd, w: Number(rec.weight)};
        }
      }
    }
    if(best) return best.w;
    return Number(state.settings.startWeight);
  }

  function bmrAdjustedCalories(base, ds){
    const w0 = Number(state.settings.startWeight);
    const w  = getWeightBefore(ds);
    const kcalPerLb = Number(state.settings.kcalPerLb);
    const minCal = Number(state.settings.minCal);
    const adj = (w - w0) * kcalPerLb;
    return clamp(Math.round(base + adj), minCal, null);
  }

  function isHighCarbDay(ds){
    const d = parseYMD(ds);
    const wi = weekIndexForDate(ds);
    if(!wi) return false;

    const s = state.settings;
    const primaryActive = wi >= Number(s.highStartWeek) && d.getDay() === Number(s.primaryHighDow);
    const secondaryActive = wi >= Number(s.secondHighStartWeek) && d.getDay() === Number(s.secondHighDow);

    return primaryActive || secondaryActive;
  }

  function reverseTarget(ds){
    const start = parseYMD(REVERSE_START);
    const end = parseYMD(REVERSE_END);
    const cur = parseYMD(ds);
    const total = Math.max(1, Math.round((end - start) / (1000*60*60*24)));
    const t = clamp((cur - start) / (total * 24*60*60*1000), 0, 1);

    const dayBefore = ymd(addDays(start, -1));
    const startCutTarget = targetForCutOnly(dayBefore);
    return Math.round(startCutTarget + (REVERSE_TARGET - startCutTarget) * t);
  }

  function targetForCutOnly(ds){
    if(SPECIAL_TARGETS[ds] !== undefined) return SPECIAL_TARGETS[ds];
    if(isFastDay(ds)) return 0;

    const base = Number(state.settings.targetCal);
    const high = Number(state.settings.highCal);

    const baseAdj = bmrAdjustedCalories(base, ds);
    const highAdj = bmrAdjustedCalories(high, ds);

    return isHighCarbDay(ds) ? highAdj : baseAdj;
  }

  function targetFor(ds){
    if(inReverseWindow(ds)) return reverseTarget(ds);
    return targetForCutOnly(ds);
  }

  function lbmBaseline(){
    const sw = Number(state.settings.startWeight);
    const sbf = Number(state.settings.startBf) / 100;
    return sw * (1 - sbf);
  }
  function expectedBfRange(ds){
    const r = expectedRange(ds);
    if(!r) return null;
    const lbm = lbmBaseline();
    const bfHigh = (1 - (lbm / r.high)) * 100;
    const bfLow  = (1 - (lbm / r.low )) * 100;
    const lo = Math.min(bfLow, bfHigh);
    const hi = Math.max(bfLow, bfHigh);
    return {low: lo, high: hi};
  }
  function fmtBfRange(b){
    if(!b) return "";
    return `${b.low.toFixed(1)}% to ${b.high.toFixed(1)}%`;
  }

  const monthsSpec = [
    {y:2026, m:0, name:"January 2026"},
    {y:2026, m:1, name:"February 2026"},
    {y:2026, m:2, name:"March 2026"},
    {y:2026, m:3, name:"April 2026"},
    {y:2026, m:4, name:"May 2026"}
  ];

  const monthTabsEl = document.getElementById("monthTabs");
  const monthTitleText = document.getElementById("monthTitleText");
  const monthLoggedPill = document.getElementById("monthLoggedPill");
  const activeMonthPill = document.getElementById("activeMonthPill");
  const monthGridEl = document.getElementById("monthGrid");

  function monthKey(y,m){ return `${y}-${m}`; }

  function computeMonthLogs(){
    const m = {};
    for(const spec of monthsSpec){ m[monthKey(spec.y,spec.m)] = 0; }
    for(const ds in state.days){
      const rec = state.days[ds];
      const hasAny = rec && (
        rec.calories!==null || rec.weight!==null || rec.bf!==null ||
        rec.protein!==null || rec.carbs!==null || rec.fat!==null || rec.fiber!==null ||
        rec.sleepHours!==null || rec.sleepQuality!==null ||
        (rec.workout && rec.workout !== "") || (rec.notes && rec.notes.trim().length)
      );
      if(!hasAny) continue;
      const d = parseYMD(ds);
      const key = monthKey(d.getFullYear(), d.getMonth());
      if(m[key]!==undefined) m[key] += 1;
    }
    return m;
  }

  function buildTabs(){
    monthTabsEl.innerHTML = "";
    const logs = computeMonthLogs();
    for(const spec of monthsSpec){
      const key = monthKey(spec.y,spec.m);
      const btn = document.createElement("div");
      btn.className = "tab" + (state.ui.activeMonthKey===key ? " active" : "");
      btn.innerHTML = `<span>${spec.name.split(" ")[0]}</span><span class="count">${logs[key]||0}</span>`;
      btn.addEventListener("click", ()=>{
        state.ui.activeMonthKey = key;
        saveState();
        renderActiveMonth();
        buildTabs();
      });
      monthTabsEl.appendChild(btn);
    }
  }

  function workoutBadgeText(v){
    if(v==="strength") return "ST";
    if(v==="hiit") return "HIIT";
    if(v==="walk") return "Walk";
    if(v==="rest") return "Rest";
    return null;
  }
  function workoutBadgeClass(v){
    if(v==="strength" || v==="hiit" || v==="walk") return "good";
    return "";
  }

  function buildMonthGrid(year, monthIndex){
    monthGridEl.innerHTML = "";

    const wide = window.matchMedia("(max-width: 860px)").matches;
    if(!wide){
      const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      for(const d of dows){
        const el=document.createElement("div");
        el.className="dow";
        el.textContent=d;
        monthGridEl.appendChild(el);
      }
    }

    const start = new Date(year, monthIndex, 1);
    const lead = start.getDay();
    const first = addDays(start, -lead);
    const todayStr = ymd(new Date());

    const loops = wide ? 35 : 42;

    for(let i=0;i<loops;i++){
      const day = addDays(first, i);
      const ds = ymd(day);
      const inMonth = day.getMonth() === monthIndex;

      const cell = document.createElement("div");
      cell.className = "day" + (inMonth ? "" : " muted");
      if(ds===todayStr) cell.classList.add("today");

      if(isFastDay(ds)) cell.classList.add("fast");

      const isReverse = inReverseWindow(ds) && !isFastDay(ds);
      if(isReverse) cell.classList.add("reverse");

      const isHigh = isHighCarbDay(ds) && !isFastDay(ds) && !isReverse;
      if(isHigh) cell.classList.add("refeed");

      const rec = state.days[ds] || {};
      const top = document.createElement("div");
      top.className="topline";

      const num=document.createElement("div");
      num.className="num";
      num.textContent=String(day.getDate());

      const badges=document.createElement("div");
      badges.className="badges";

      if(isFastDay(ds)){
        const b=document.createElement("span"); b.className="badge warn"; b.textContent="FAST"; badges.appendChild(b);
      }
      if(isReverse){
        const b=document.createElement("span"); b.className="badge"; b.textContent="Reverse"; badges.appendChild(b);
      }
      if(isHigh){
        const b=document.createElement("span"); b.className="badge good"; b.textContent="High-carb"; badges.appendChild(b);
      }
      if(isWeighDay(day)){
        const b=document.createElement("span"); b.className="badge"; b.textContent="Weigh"; badges.appendChild(b);
      }

      const wb = workoutBadgeText(rec.workout);
      if(wb){
        const b=document.createElement("span");
        b.className="badge " + workoutBadgeClass(rec.workout);
        b.textContent=wb;
        badges.appendChild(b);
      }

      top.appendChild(num); top.appendChild(badges);
      cell.appendChild(top);

      const tgt = targetFor(ds);

      const calLine=document.createElement("div");
      calLine.className="line";
      const cal = (rec.calories===null || rec.calories===undefined) ? "-" : rec.calories;
      calLine.innerHTML = `Calories: <b>${cal}</b> <span class="mono">/ ${tgt}</span>`;
      cell.appendChild(calLine);

      const wtLine=document.createElement("div");
      wtLine.className="line";
      const wt = (rec.weight===null || rec.weight===undefined) ? "-" : Number(rec.weight).toFixed(1);
      wtLine.innerHTML = `Weight: <b>${wt}</b>`;
      cell.appendChild(wtLine);

      const bfLine=document.createElement("div");
      bfLine.className="line";
      const bfVal = (rec.bf===null || rec.bf===undefined) ? "-" : Number(rec.bf).toFixed(1) + "%";
      bfLine.innerHTML = `BF%: <b>${bfVal}</b>`;
      cell.appendChild(bfLine);

      // Sleep (optional)
      if(rec.sleepHours!==null && rec.sleepHours!==undefined && rec.sleepHours!==""){
        const slLine=document.createElement("div");
        slLine.className="line";
        const sh = Number(rec.sleepHours).toFixed(1) + "h";
        const sq = (rec.sleepQuality!==null && rec.sleepQuality!==undefined && rec.sleepQuality!=="") ? ` (Q${rec.sleepQuality})` : "";
        slLine.innerHTML = `Sleep: <b>${sh}${sq}</b>`;
        cell.appendChild(slLine);
      }

      // Macros (optional)
      const hasMacros = rec && (
        rec.protein!==null && rec.protein!==undefined ||
        rec.carbs!==null && rec.carbs!==undefined ||
        rec.fat!==null && rec.fat!==undefined ||
        rec.fiber!==null && rec.fiber!==undefined
      );
      if(hasMacros){
        const mLine = document.createElement("div");
        mLine.className = "tiny";
        const p = (rec.protein===null || rec.protein===undefined) ? "-" : Math.round(rec.protein);
        const c = (rec.carbs===null || rec.carbs===undefined) ? "-" : Math.round(rec.carbs);
        const f = (rec.fat===null || rec.fat===undefined) ? "-" : Math.round(rec.fat);
        const fi = (rec.fiber===null || rec.fiber===undefined) ? null : Math.round(rec.fiber);
        mLine.innerHTML = `Macros: <b>P${p}</b> / <b>C${c}</b> / <b>F${f}</b>${fi!==null?` <span class="muted">(Fi${fi})</span>`:""}`;
        cell.appendChild(mLine);
      }

      const exp = expectedRange(ds);
      if(exp){
        const expLine=document.createElement("div");
        expLine.className="line";
        expLine.innerHTML = `Expected: <b>${fmtRange(exp)}</b>`;
        cell.appendChild(expLine);

        const eb = expectedBfRange(ds);
        if(eb){
          const ebLine=document.createElement("div");
          ebLine.className="line";
          ebLine.innerHTML = `Exp BF%: <b>${fmtBfRange(eb)}</b>`;
          cell.appendChild(ebLine);
        }
      }

      if(rec.notes && rec.notes.trim().length){
        const note=document.createElement("div");
        note.className="line";
        const sn = rec.notes.trim().slice(0, 56);
        const safe = rec.notes.replaceAll('"','&quot;');
        note.innerHTML = `Note: <b title="${safe}">${sn}${rec.notes.length>56 ? "…" : ""}</b>`;
        cell.appendChild(note);
      }else{
        const spacer=document.createElement("div");
        spacer.style.flex="1";
        cell.appendChild(spacer);
      }

      if(inMonth){
        cell.addEventListener("click", ()=> openModal(ds));
      }
      monthGridEl.appendChild(cell);
    }
  }

  function renderActiveMonth(){
    const key = state.ui.activeMonthKey || "2026-0";
    const parts = key.split("-").map(Number);
    const yy = parts[0], mm = parts[1];
    const spec = monthsSpec.find(x => x.y===yy && x.m===mm) || monthsSpec[0];

    monthTitleText.textContent = spec.name;

    const logs = computeMonthLogs();
    monthLoggedPill.innerHTML = `<b>Logged days:</b> ${logs[monthKey(spec.y,spec.m)]||0}`;
    activeMonthPill.innerHTML = `<b>Month:</b> ${spec.name}`;

    buildMonthGrid(spec.y, spec.m);
  }

  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const tagPill = document.getElementById("tagPill");
  const saveIndicator = document.getElementById("saveIndicator");

  const dayTarget = document.getElementById("dayTarget");
  const expectedWeight = document.getElementById("expectedWeight");
  const expectedBf = document.getElementById("expectedBf");
  const lbmBase = document.getElementById("lbmBase");

  const calories = document.getElementById("calories");
  const workout = document.getElementById("workout");
  const weight = document.getElementById("weight");
  const bf = document.getElementById("bf");
  const protein = document.getElementById("protein");
  const carbs = document.getElementById("carbs");
  const fat = document.getElementById("fat");
  const fiber = document.getElementById("fiber");
  const notes = document.getElementById("notes");
  const sleepHours = document.getElementById("sleepHours");
  const sleepQuality = document.getElementById("sleepQuality");
  const bedtime = document.getElementById("bedtime");
  const waketime = document.getElementById("waketime");
  const vsExpectedNote = document.getElementById("vsExpectedNote");

  const closeBtn = document.getElementById("closeBtn");
  const clearDayBtn = document.getElementById("clearDayBtn");

  let activeDate = null;
  let _timer = null;

  function setSaveIndicator(text, cls){
    saveIndicator.classList.remove("good","warn","bad");
    if(cls) saveIndicator.classList.add(cls);
    saveIndicator.innerHTML = `<b>Saved:</b> ${text}`;
  }

  function updateVsExpected(ds){
    const exp = expectedRange(ds);
    const w = (weight.value==="" ? null : Number(weight.value));
    const b = (bf.value==="" ? null : Number(bf.value));

    if(!exp){
      expectedWeight.value = "";
      expectedBf.value = "";
      vsExpectedNote.textContent = "No expected target for this day (not a weigh-in day).";
      return null;
    }

    expectedWeight.value = fmtRange(exp);
    const eb = expectedBfRange(ds);
    expectedBf.value = eb ? fmtBfRange(eb) : "";

    let msgParts = [];
    if(w===null || Number.isNaN(w)){
      msgParts.push("Enter weight to compare against expected range.");
    } else {
      if(w < exp.low) msgParts.push(`Below expected by ${(exp.low - w).toFixed(1)} lb (fine).`);
      else if(w > exp.high) msgParts.push(`Above expected by ${(w - exp.high).toFixed(1)} lb (likely water unless persistent).`);
      else msgParts.push("Within expected weight range.");
    }

    if(eb && b!==null && !Number.isNaN(b)){
      if(b < eb.low) msgParts.push(`BF% is below expected range by ${(eb.low - b).toFixed(1)}%.`);
      else if(b > eb.high) msgParts.push(`BF% is above expected range by ${(b - eb.high).toFixed(1)}%.`);
      else msgParts.push("BF% is within expected range.");
    } else if(eb) {
      msgParts.push("BF% is optional. Enter it if you want a second anchor.");
    }

    vsExpectedNote.textContent = msgParts.join(" ");
    return {status:"good"};
  }

  function openModal(ds){
    activeDate = ds;
    const d = parseYMD(ds);
    modalTitle.textContent = `${weekdayName(d)} - ${ds}`;
    modalSub.textContent = isWeighDay(d) ? "Weigh-in day (Mon/Thu). Log before food or water." : "Calories + workout + notes.";

    const tgt = targetFor(ds);
    dayTarget.value = tgt;

    const exp = expectedRange(ds);
    expectedWeight.value = exp ? fmtRange(exp) : "";
    const eb = expectedBfRange(ds);
    expectedBf.value = eb ? fmtBfRange(eb) : "";

    const lbm = lbmBaseline();
    lbmBase.value = `${lbm.toFixed(1)} lbs (est.)`;

    const rec = state.days[ds] || {};
    calories.value = (rec.calories===null || rec.calories===undefined) ? "" : rec.calories;
    workout.value = rec.workout || "";
    weight.value = (rec.weight===null || rec.weight===undefined) ? "" : rec.weight;
    bf.value = (rec.bf===null || rec.bf===undefined) ? "" : rec.bf;

    protein.value = (rec.protein===null || rec.protein===undefined) ? "" : rec.protein;
    carbs.value   = (rec.carbs===null || rec.carbs===undefined) ? "" : rec.carbs;
    fat.value     = (rec.fat===null || rec.fat===undefined) ? "" : rec.fat;
    fiber.value   = (rec.fiber===null || rec.fiber===undefined) ? "" : rec.fiber;

    notes.value = rec.notes || "";

    sleepHours.value = (rec.sleepHours===null || rec.sleepHours===undefined) ? "" : rec.sleepHours;
    sleepQuality.value = (rec.sleepQuality===null || rec.sleepQuality===undefined) ? "" : String(rec.sleepQuality);
    bedtime.value = rec.bedtime || "";
    waketime.value = rec.waketime || "";

    if(isFastDay(ds)) tagPill.innerHTML = "<b>Target:</b> FAST (0)";
    else if(inReverseWindow(ds)) tagPill.innerHTML = `<b>Target:</b> Reverse (${tgt})`;
    else if(isHighCarbDay(ds)) tagPill.innerHTML = `<b>Target:</b> High-carb (${tgt})`;
    else tagPill.innerHTML = `<b>Target:</b> ${tgt}`;

    updateVsExpected(ds);
    setSaveIndicator("Saved", "good");
    modal.classList.add("open");
  }

  function autosaveDebounced(){
    if(!activeDate) return;
    if(_timer) clearTimeout(_timer);
    setSaveIndicator("Saving...", "warn");
    _timer = setTimeout(()=>{
      const rec = {
        calories: calories.value==="" ? null : Number(calories.value),
        workout: workout.value || "",
        weight: weight.value==="" ? null : Number(weight.value),
        bf: bf.value==="" ? null : Number(bf.value),

        protein: protein.value==="" ? null : Number(protein.value),
        carbs: carbs.value==="" ? null : Number(carbs.value),
        fat: fat.value==="" ? null : Number(fat.value),
        fiber: fiber.value==="" ? null : Number(fiber.value),

        notes: notes.value.trim(),
        sleepHours: sleepHours.value==="" ? null : Number(sleepHours.value),
        sleepQuality: sleepQuality.value==="" ? null : Number(sleepQuality.value),
        bedtime: bedtime.value || "",
        waketime: waketime.value || ""
      };
      state.days[activeDate] = rec;
      saveState();
      setSaveIndicator("Saved", "good");
      renderAll();
    }, 260);
  }

  
  // Flush the current day record immediately (used on modal close so last edits aren't lost)
  function saveActiveDayImmediate(){
    if(!activeDate) return;
    const rec = {
      calories: calories.value==="" ? null : Number(calories.value),
      workout: workout.value || "",
      weight: weight.value==="" ? null : Number(weight.value),
      bf: bf.value==="" ? null : Number(bf.value),

      protein: protein.value==="" ? null : Number(protein.value),
      carbs: carbs.value==="" ? null : Number(carbs.value),
      fat: fat.value==="" ? null : Number(fat.value),
      fiber: fiber.value==="" ? null : Number(fiber.value),

      notes: notes.value.trim(),
      sleepHours: sleepHours.value==="" ? null : Number(sleepHours.value),
      sleepQuality: sleepQuality.value==="" ? null : Number(sleepQuality.value),
      bedtime: bedtime.value || "",
      waketime: waketime.value || ""
    };
    state.days[activeDate] = rec;
    saveState();
    setSaveIndicator("Saved", "good");
  }

[calories, workout, weight, bf, protein, carbs, fat, fiber, notes, sleepHours, sleepQuality, bedtime, waketime].forEach(el=>{
    el.addEventListener("input", ()=>{ if(activeDate) updateVsExpected(activeDate); autosaveDebounced(); });
    el.addEventListener("change", ()=>{ if(activeDate) updateVsExpected(activeDate); autosaveDebounced(); });
  });

  function closeModal(){
    // Ensure latest edits (including macros) persist even if you close quickly
    saveActiveDayImmediate();
    if(_timer) { clearTimeout(_timer); _timer = null; }
    modal.classList.remove("open");
    activeDate = null;
    renderAll();
  }
  closeBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

  clearDayBtn.addEventListener("click", ()=>{
    if(!activeDate) return;
    delete state.days[activeDate];
    saveState();
    closeModal();
  });

  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "15_Week_Body_Transformation_export.json"; a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById("importBtn").addEventListener("click", ()=>{
    const inp=document.createElement("input");
    inp.type="file"; inp.accept="application/json";
    inp.onchange = ()=>{
      const file=inp.files && inp.files[0];
      if(!file) return;
      const r=new FileReader();
      r.onload = ()=>{
        try{
          const data=JSON.parse(String(r.result||"{}"));
          if(!data.days) data.days={};
          if(!data.settings) data.settings=state.settings;
          if(!data.ui) data.ui=state.ui;

          const defSettings = {...state.settings};
          data.settings = {...defSettings, ...data.settings};
          const defUi = {...state.ui};
          data.ui = {...defUi, ...data.ui};

          state=data;
          saveState();
          syncSettingsToUI();
    wireSettings();
          renderAll();
        }catch(e){ alert("Import failed. Choose a valid export file."); }
      };
      r.readAsText(file);
    };
    inp.click();
  });

  document.getElementById("resetBtn").addEventListener("click", async ()=>{
    try{
      if(!supabase){
        alert("Cloud sync is not configured in this build.");
        return;
      }
      const { data, error } = await supabase.auth.getUser();
      if(error){
        alert(error.message || "Unable to verify sign-in.");
        return;
      }
      if(!data || !data.user){
        alert("Please sign in before resetting data.");
        return;
      }
      const phrase = prompt('Type RESET to confirm deleting all saved data.');
      if(phrase !== "RESET") return;

      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(LOCAL_CACHE_KEY);
      state = loadState();
      syncSettingsToUI();
    wireSettings();
      renderAll();
      alert("Local data reset. If cloud sync is enabled, refresh to pull cloud data.");
    }catch(e){
      console.error(e);
      alert("Reset failed. Check DevTools Console for details.");
    }
  });

  function parseCSV(text){
    const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
    if(!lines.length) return [];
    const rows = lines.map(l=>l.split(/,|\t/).map(x=>x.trim()));
    const first0 = rows[0][0] || "";
    const looksLikeDate = /^\d{4}-\d{2}-\d{2}$/.test(first0);
    const startIdx = looksLikeDate ? 0 : 1;
    const out=[];
    for(let i=startIdx;i<rows.length;i++){
      const r=rows[i];
      const date=r[0];
      const cal=r[1];
      if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;
      const c = Number(String(cal||"").replace(/[^0-9.]/g,""));
      if(!Number.isFinite(c)) continue;
      out.push({date, calories: Math.round(c)});
    }
    return out;
  }

  document.getElementById("importCaloriesBtn").addEventListener("click", ()=>{
    const inp=document.createElement("input");
    inp.type="file"; inp.accept=".csv,text/csv,text/plain";
    inp.onchange = ()=>{
      const file=inp.files && inp.files[0];
      if(!file) return;
      const r=new FileReader();
      r.onload = ()=>{
        const items = parseCSV(String(r.result||""));
        if(!items.length){ alert("No rows found. CSV should be: date,calories (YYYY-MM-DD)."); return; }
        for(const it of items){
          if(!state.days[it.date]) state.days[it.date] = {calories:null, workout:"", weight:null, bf:null, notes:""};
          state.days[it.date].calories = it.calories;
        }
        saveState(); renderAll();
        alert(`Imported calories for ${items.length} day(s).`);
      };
      r.readAsText(file);
    };
    inp.click();
  });

  const settingsEls = [
    startDateEl, startWeightEl, startBfEl, targetCalEl, highCalEl, highStartWeekEl, secondHighStartWeekEl,
    kcalPerLbEl, minCalEl, adhWindowEl, primaryHighDowEl, secondHighDowEl
  ];
  settingsEls.forEach(el=>{
    el.addEventListener("input", ()=>{
      state.settings.startDate = startDateEl.value || "2026-01-05";
      state.settings.startWeight = Number(startWeightEl.value||221.6);
      state.settings.startBf = Number(startBfEl.value||25.0);
      state.settings.targetCal = Number(targetCalEl.value||2200);
      state.settings.highCal = Number(highCalEl.value||2400);
      state.settings.highStartWeek = Number(highStartWeekEl.value||3);
      state.settings.secondHighStartWeek = Number(secondHighStartWeekEl.value||10);
      state.settings.kcalPerLb = Number(kcalPerLbEl.value||10);
      state.settings.minCal = Number(minCalEl.value||1700);
      state.settings.adhWindow = Number(adhWindowEl.value||150);
      state.settings.primaryHighDow = Number(primaryHighDowEl.value||0);
      state.settings.secondHighDow = Number(secondHighDowEl.value||3);
      saveState(); renderAll();
    });
    el.addEventListener("change", ()=>{
      state.settings.primaryHighDow = Number(primaryHighDowEl.value||0);
      state.settings.secondHighDow = Number(secondHighDowEl.value||3);
      saveState(); renderAll();
    });
  });

  function getWeighIns(){
    const out=[];
    for(const ds in state.days){
      const rec = state.days[ds];
      if(rec && rec.weight!==null && rec.weight!==undefined){
        out.push({ ds, d: parseYMD(ds), w: Number(rec.weight) });
      }
    }
    out.sort((a,b)=>a.d-b.d);
    return out;
  }
  function getBfIns(){
    const out=[];
    for(const ds in state.days){
      const rec = state.days[ds];
      if(rec && rec.bf!==null && rec.bf!==undefined){
        out.push({ ds, d: parseYMD(ds), bf: Number(rec.bf) });
      }
    }
    out.sort((a,b)=>a.d-b.d);
    return out;
  }

  function lastNDays(anchor, n){
    const a = parseYMD(anchor);
    const out=[];
    const start = addDays(a, -(n-1));
    for(let d=new Date(start); ymd(d)<=anchor; d=addDays(d,1)){
      out.push(ymd(d));
    }
    return out;
  }

  function compute7Day(){
    const anchor = ymd(new Date());
    const days = lastNDays(anchor, 7);
    const win = Number(state.settings.adhWindow || 150);

    let calSum=0, calCount=0, on=0, logged=0;

    let sleepSum=0, sleepCount=0, sleepOn=0;
    const sleepTarget = Number(state.settings.sleepTarget || 7.0);

    let pSum=0,pCount=0, cSum=0,cCount=0, fSum=0,fCount=0;

    for(const ds of days){
      const rec = state.days[ds];

      if(rec && rec.calories!==null && rec.calories!==undefined){
        const c = Number(rec.calories);
        calSum += c; calCount++;
        logged++;
        const tgt = targetFor(ds);
        if(Math.abs(c - tgt) <= win) on++;
      }

      if(rec && rec.sleepHours!==null && rec.sleepHours!==undefined){
        const sh = Number(rec.sleepHours);
        sleepSum += sh; sleepCount++;
        if(isFinite(sleepTarget) && sh >= sleepTarget) sleepOn++;
      }

      if(rec && rec.protein!==null && rec.protein!==undefined){ pSum += Number(rec.protein); pCount++; }
      if(rec && rec.carbs!==null && rec.carbs!==undefined){ cSum += Number(rec.carbs); cCount++; }
      if(rec && rec.fat!==null && rec.fat!==undefined){ fSum += Number(rec.fat); fCount++; }
    }

    return {
      avgCal: calCount ? (calSum/calCount) : null,
      adh: logged ? (on/logged) : null,
      loggedDays: logged,

      avgSleep: sleepCount ? (sleepSum/sleepCount) : null,
      sleepLogged: sleepCount,
      sleepAdh: sleepCount ? (sleepOn/sleepCount) : null,

      avgProtein: pCount ? (pSum/pCount) : null,
      avgCarbs: cCount ? (cSum/cCount) : null,
      avgFat: fCount ? (fSum/fCount) : null,
      macroLogged: Math.max(pCount, cCount, fCount)
    };
  }

  function setPill(id, cls, html){
    const el = document.getElementById(id);
    el.classList.remove("good","warn","bad");
    if(cls) el.classList.add(cls);
    el.innerHTML = html;
  }

  function renderKpis(){
    const ws = getWeighIns();
    const current = ws.length ? ws[ws.length-1] : null;
    document.getElementById("kpiCurrent").textContent = current ? `${current.w.toFixed(1)} lbs` : "-";

    const bfs = getBfIns();
    const currentBf = bfs.length ? bfs[bfs.length-1] : null;
    document.getElementById("kpiCurrentBf").textContent = currentBf ? `${currentBf.bf.toFixed(1)}%` : "-";

    // Start baselines + deltas (if elements exist)
    const startW = Number(state.settings.startWeight || 0);
    const startBf = Number(state.settings.startBf || 0);

    const elStartW = document.getElementById("kpiStartW");
    if(elStartW) elStartW.textContent = startW ? `${startW.toFixed(1)} lbs` : "-";

    const elStartBf = document.getElementById("kpiStartBf");
    if(elStartBf) elStartBf.textContent = startBf ? `${startBf.toFixed(1)}%` : "-";

    const elDeltaW = document.getElementById("kpiDeltaW");
    if(elDeltaW){
      if(current && startW){
        const dw = current.w - startW;
        const sign = dw >= 0 ? "+" : "";
        elDeltaW.textContent = `Change since start: ${sign}${dw.toFixed(1)} lbs`;
      }else{
        elDeltaW.textContent = "Change since start: -";
      }
    }

    const elDeltaBf = document.getElementById("kpiDeltaBf");
    if(elDeltaBf){
      if(currentBf && startBf){
        const db = currentBf.bf - startBf;
        const sign = db >= 0 ? "+" : "";
        elDeltaBf.textContent = `Change since start: ${sign}${db.toFixed(1)}%`;
      }else{
        elDeltaBf.textContent = "Change since start: -";
      }
    }


    const d7 = compute7Day();
    document.getElementById("kpiAvgCal").textContent = (d7.avgCal===null) ? "-" : `${Math.round(d7.avgCal)} kcal`;
    document.getElementById("kpiAdh").textContent = (d7.adh===null) ? "-" : `${Math.round(d7.adh*100)}%`;
    const kSleep = document.getElementById("kpiAvgSleep");
    if(kSleep) kSleep.textContent = (d7.avgSleep===null) ? "-" : `${d7.avgSleep.toFixed(1)} h`;
    const kP = document.getElementById("kpiAvgProtein");
    if(kP) kP.textContent = (d7.avgProtein===null) ? "-" : `${Math.round(d7.avgProtein)} g`;
    const kC = document.getElementById("kpiAvgCarbs");
    if(kC) kC.textContent = (d7.avgCarbs===null) ? "-" : `${Math.round(d7.avgCarbs)} g`;
    const kF = document.getElementById("kpiAvgFat");
    if(kF) kF.textContent = (d7.avgFat===null) ? "-" : `${Math.round(d7.avgFat)} g`;


    if(d7.adh===null){
      setPill("dietPill","warn", "<b>Diet:</b> Log calories to score");
    }else{
      const pct = d7.adh*100;
      if(pct>=75) setPill("dietPill","good", `<b>Diet:</b> ${Math.round(pct)}% on target`);
      else if(pct>=50) setPill("dietPill","warn", `<b>Diet:</b> ${Math.round(pct)}% on target`);
      else setPill("dietPill","bad", `<b>Diet:</b> ${Math.round(pct)}% on target`);
    }

    setPill("statusPill", null, "<b>Status:</b> Tracking live");
  }

  function nextWeighInTarget(){
    const today = new Date();
    for(let i=0;i<200;i++){
      const d = addDays(today, i);
      const ds = ymd(d);
      if(isWeighDay(d)){
        const exp = expectedRange(ds);
        if(exp) return {ds, range: fmtRange(exp), bfRange: fmtBfRange(expectedBfRange(ds))};
        return {ds, range:"Weigh-in", bfRange:""};
      }
    }
    return null;
  }

  
  function safeEl(id){ return document.getElementById(id); }

  let __sparkId = 0;
  function fmtMD(ymdStr){
    try{
      const d = parseYMD(ymdStr);
      return d.toLocaleDateString("en-US",{month:"2-digit",day:"2-digit"});
    }catch(e){ return ""; }
  }

  function sparkline(points, opts={}){
    const w = opts.w ?? 320;
    const h = opts.h ?? 120;
    const unit = opts.unit ?? "";
    const yLabel = opts.yLabel ?? "";
    const xLabels = opts.xLabels ?? null; // [start, end]
    const goal = (opts.goal!==undefined && opts.goal!==null && isFinite(opts.goal)) ? Number(opts.goal) : null;
    const goalLabel = opts.goalLabel ?? "Goal";
    const autoColor = !!opts.autoColor;
    const explicitColor = opts.color ?? null;

    const vals = points.filter(v=>v!==null && v!==undefined && isFinite(v));
    if(vals.length < 2) return `<div class="tiny muted" style="padding:10px;">Not enough data yet.</div>`;

    let min = Math.min(...vals);
    let max = Math.max(...vals);
    if(goal!==null){
      min = Math.min(min, goal);
      max = Math.max(max, goal);
    }
    const span = (max-min) || 1;

    const padL = 42, padR = 10, padT = 10, padB = 34;
    const plotW = w - padL - padR;
    const plotH = h - padT - padB;

    const xs = points.map((_,i)=> padL + (plotW * (points.length===1 ? 0 : i/(points.length-1))));
    const yOf = (v)=>{
      const t = (v - min) / span;
      return (padT+plotH) - t*plotH;
    };
    const ys = points.map(v => (v===null || v===undefined || !isFinite(v)) ? null : yOf(Number(v)));

    // Build path with gaps
    let d = "";
    for(let i=0;i<xs.length;i++){
      if(ys[i]===null) continue;
      d += (d ? " L " : "M ") + `${xs[i].toFixed(1)} ${ys[i].toFixed(1)}`;
    }
    if(!d) return `<div class="tiny muted" style="padding:10px;">Not enough data yet.</div>`;

    // Auto-color by direction (first->last)
    let lineColor = explicitColor || "var(--accent)";
    if(autoColor){
      const first = vals[0];
      const last = vals[vals.length-1];
      if(isFinite(first) && isFinite(last)){
        if(last < first) lineColor = "var(--good)";
        else if(last > first) lineColor = "var(--bad)";
        else lineColor = "var(--accent)";
      }
    }

    const yMax = max;
    const yMin = min;
    const yMid = min + span/2;

    const id = (++__sparkId);
    const goalY = (goal!==null) ? yOf(goal) : null;

    const fmt = (v)=> (Math.abs(v) >= 100 ? v.toFixed(0) : v.toFixed(1)) + (unit ? ` ${unit}` : "");
    const x0 = xLabels ? (xLabels[0] ?? "") : "";
    const xM = xLabels ? (xLabels.length >= 3 ? (xLabels[1] ?? "") : "") : "";
    const x1 = xLabels ? (xLabels.length >= 3 ? (xLabels[2] ?? "") : (xLabels[1] ?? "")) : "";

    return `
      <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-hidden="true">
        <defs>
          <linearGradient id="sparkFill${id}" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="rgba(59,130,246,.22)"/>
            <stop offset="100%" stop-color="rgba(59,130,246,0)"/>
          </linearGradient>
        </defs>

        <!-- Grid -->
        <line class="gridLine" x1="${padL}" x2="${w-padR}" y1="${padT}" y2="${padT}"></line>
        <line class="gridLine" x1="${padL}" x2="${w-padR}" y1="${(padT+plotH/2).toFixed(1)}" y2="${(padT+plotH/2).toFixed(1)}"></line>
        <line class="gridLine" x1="${(padL+plotW/2).toFixed(1)}" x2="${(padL+plotW/2).toFixed(1)}" y1="${padT}" y2="${(padT+plotH).toFixed(1)}"></line>
        <line class="gridLine" x1="${padL}" x2="${w-padR}" y1="${(padT+plotH).toFixed(1)}" y2="${(padT+plotH).toFixed(1)}"></line>

        <!-- Axes -->
        <line class="axisLine" x1="${padL}" x2="${padL}" y1="${padT}" y2="${padT+plotH}"></line>
        <line class="axisLine" x1="${padL}" x2="${w-padR}" y1="${padT+plotH}" y2="${padT+plotH}"></line>

        <!-- Axis labels -->
        ${yLabel ? `<text class="titleText" x="${(padL+2)}" y="${(padT+10)}">${yLabel}</text>` : ``}
        <text class="axisText" x="${padL-4}" y="${(padT+4)}" text-anchor="end">${fmt(yMax)}</text>
        <text class="axisText" x="${padL-4}" y="${(padT+plotH/2+4).toFixed(1)}" text-anchor="end">${fmt(yMid)}</text>
        <text class="axisText" x="${padL-4}" y="${(padT+plotH+4).toFixed(1)}" text-anchor="end">${fmt(yMin)}</text>

        ${x0 ? `<text class="axisText" x="${padL}" y="${(padT+plotH+14).toFixed(1)}" text-anchor="start">${x0}</text>` : ``}
        ${xM ? `<text class="axisText" x="${(padL+plotW/2).toFixed(1)}" y="${(padT+plotH+14).toFixed(1)}" text-anchor="middle">${xM}</text>` : ``}
        ${x1 ? `<text class="axisText" x="${(w-padR)}" y="${(padT+plotH+14).toFixed(1)}" text-anchor="end">${x1}</text>` : ``}

        <!-- Goal -->
        ${goalY!==null ? `
          <line x1="${padL}" x2="${(w-padR)}" y1="${goalY.toFixed(1)}" y2="${goalY.toFixed(1)}"
            stroke="var(--warn)" stroke-width="1" stroke-dasharray="4 3"></line>
          <text class="legendText" x="${(w-padR)}" y="${(goalY-2).toFixed(1)}" text-anchor="end">${goalLabel}</text>
        ` : ``}

        <!-- Line -->
        <path d="${d}" fill="none" stroke="${lineColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
    `;
  }


  function barSpark(values, opts={}){
    const w = opts.w ?? 320;
    const h = opts.h ?? 110;
    const unit = opts.unit ?? "";
    const yLabel = opts.yLabel ?? "";
    const xLabels = opts.xLabels ?? null; // [start, end]

    const vals = values.filter(v=>v!==null && v!==undefined && isFinite(v));
    if(vals.length < 2) return `<div class="tiny muted" style="padding:10px;">Not enough data yet.</div>`;

    const padL = 42, padR = 10, padT = 10, padB = 20;
    const plotW = w - padL - padR;
    const plotH = h - padT - padB;

    const maxAbs = Math.max(...vals.map(v=>Math.abs(v)), 1);
    const scale = (plotH/2) / maxAbs;
    const baselineY = padT + plotH/2;

    const n = values.length;
    const barW = plotW / n;
    const gap = Math.min(2, barW*0.12);

    let rects = "";
    for(let i=0;i<n;i++){
      const v = values[i];
      if(v===null || v===undefined || !isFinite(v)) continue;
      const vv = Number(v);
      const bh = Math.abs(vv) * scale;
      const x = padL + i*barW + gap;
      const y = vv >= 0 ? (baselineY - bh) : baselineY;
      const fill = vv >= 0 ? "var(--bad)" : "var(--good)";
      rects += `<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${Math.max(1, barW-2*gap).toFixed(1)}" height="${Math.max(1, bh).toFixed(1)}" rx="2" ry="2" fill="${fill}" opacity="0.75"></rect>`;
    }

    const fmt = (v)=> `${Math.round(v)}${unit ? ` ${unit}` : ""}`;
    const x0 = xLabels ? (xLabels[0] ?? "") : "";
    const xM = xLabels ? (xLabels.length >= 3 ? (xLabels[1] ?? "") : "") : "";
    const x1 = xLabels ? (xLabels.length >= 3 ? (xLabels[2] ?? "") : (xLabels[1] ?? "")) : "";

    return `
      <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-hidden="true">
        <!-- Grid -->
        <line class="gridLine" x1="${padL}" x2="${w-padR}" y1="${padT}" y2="${padT}"></line>
        <line class="gridLine" x1="${padL}" x2="${w-padR}" y1="${baselineY.toFixed(1)}" y2="${baselineY.toFixed(1)}"></line>
        <line class="gridLine" x1="${(padL+plotW/2).toFixed(1)}" x2="${(padL+plotW/2).toFixed(1)}" y1="${padT}" y2="${(padT+plotH).toFixed(1)}"></line>
        <line class="gridLine" x1="${padL}" x2="${w-padR}" y1="${(padT+plotH).toFixed(1)}" y2="${(padT+plotH).toFixed(1)}"></line>

        <!-- Axes -->
        <line class="axisLine" x1="${padL}" x2="${padL}" y1="${padT}" y2="${padT+plotH}"></line>
        <line class="axisLine" x1="${padL}" x2="${w-padR}" y1="${padT+plotH}" y2="${padT+plotH}"></line>

        ${yLabel ? `<text class="titleText" x="${(padL+2)}" y="${(padT+10)}">${yLabel}</text>` : ``}

        <!-- Y labels -->
        <text class="axisText" x="${padL-4}" y="${(padT+4)}" text-anchor="end">${fmt(maxAbs)}</text>
        <text class="axisText" x="${padL-4}" y="${(baselineY+4).toFixed(1)}" text-anchor="end">0</text>
        <text class="axisText" x="${padL-4}" y="${(padT+plotH+4).toFixed(1)}" text-anchor="end">-${fmt(maxAbs)}</text>

        ${x0 ? `<text class="axisText" x="${padL}" y="${(padT+plotH+14).toFixed(1)}" text-anchor="start">${x0}</text>` : ``}
        ${xM ? `<text class="axisText" x="${(padL+plotW/2).toFixed(1)}" y="${(padT+plotH+14).toFixed(1)}" text-anchor="middle">${xM}</text>` : ``}
        ${x1 ? `<text class="axisText" x="${(w-padR)}" y="${(padT+plotH+14).toFixed(1)}" text-anchor="end">${x1}</text>` : ``}

        <!-- Bars -->
        ${rects}

        <!-- Legend (below chart) -->
        <rect x="${(padL+plotW/2-44).toFixed(1)}" y="${(padT+plotH+20).toFixed(1)}" width="10" height="10" fill="var(--good)" opacity="0.75"></rect>
        <text class="legendText" x="${(padL+plotW/2-30).toFixed(1)}" y="${(padT+plotH+29).toFixed(1)}">Under</text>
        <rect x="${(padL+plotW/2+10).toFixed(1)}" y="${(padT+plotH+20).toFixed(1)}" width="10" height="10" fill="var(--bad)" opacity="0.75"></rect>
        <text class="legendText" x="${(padL+plotW/2+24).toFixed(1)}" y="${(padT+plotH+29).toFixed(1)}">Over</text>
      </svg>
    `;
  }


  function renderTrends(){
    const elW = safeEl("sparkWeight");
    const elC = safeEl("sparkCalories");
    const elS = safeEl("sparkSleep");
    const elWT = safeEl("weekdayTable");
    if(!elW || !elC || !elS || !elWT) return;

    const today = ymd(new Date());
    const win = Number(state.settings.adhWindow || 150);
    const sleepTarget = Number(state.settings.sleepTarget || 7.0);

    const wDays = lastNDays(today, 21);
    const wSeries = wDays.map(ds=>{
      const rec = state.days[ds];
      return rec && rec.weight!==null && rec.weight!==undefined ? Number(rec.weight) : null;
    });
    elW.innerHTML = sparkline(wSeries, {unit:"lb", yLabel:"lb", xLabels:[fmtMD(wDays[0]), fmtMD(wDays[Math.floor(wDays.length/2)]), fmtMD(wDays[wDays.length-1])], autoColor:true});

    const cDays = lastNDays(today, 14);
    const cSeries = cDays.map(ds=>{
      const rec = state.days[ds];
      if(!rec || rec.calories===null || rec.calories===undefined) return null;
      const tgt = targetFor(ds);
      return Number(rec.calories) - tgt;
    });
    elC.innerHTML = barSpark(cSeries, {unit:"kcal", yLabel:"kcal vs tgt", xLabels:[fmtMD(cDays[0]), fmtMD(cDays[Math.floor(cDays.length/2)]), fmtMD(cDays[cDays.length-1])]});

    const sSeries = cDays.map(ds=>{
      const rec = state.days[ds];
      return rec && rec.sleepHours!==null && rec.sleepHours!==undefined ? Number(rec.sleepHours) : null;
    });
    const sValsForColor = sSeries.filter(v=>v!==null);
    const sAvgForColor = sValsForColor.length ? (sValsForColor.reduce((a,b)=>a+b,0)/sValsForColor.length) : null;
    const sColor = (sAvgForColor===null) ? "var(--accent)" : (sAvgForColor>=sleepTarget ? "var(--good)" : (sAvgForColor>=sleepTarget-0.5 ? "var(--warn)" : "var(--bad)"));
    elS.innerHTML = sparkline(sSeries, {unit:"h", yLabel:"hrs", xLabels:[fmtMD(cDays[0]), fmtMD(cDays[Math.floor(cDays.length/2)]), fmtMD(cDays[cDays.length-1])], goal:sleepTarget, goalLabel:`Goal ${sleepTarget.toFixed(1)}h`, color:sColor});

    // Notes
    const wNote = safeEl("sparkWeightNote");
    const cNote = safeEl("sparkCaloriesNote");
    const sNote = safeEl("sparkSleepNote");
    if(wNote){
      const last = [...wSeries].reverse().find(v=>v!==null);
      if(last===undefined){ wNote.textContent = "-"; }
      else {
        const vv = wSeries.filter(v=>v!==null);
        const mn = vv.length ? Math.min(...vv) : null;
        const mx = vv.length ? Math.max(...vv) : null;
        wNote.textContent = `Latest: ${last.toFixed(1)} lb` + (mn!==null && mx!==null ? ` • Range: ${mn.toFixed(1)}-${mx.toFixed(1)}` : "");
      }
    }
    if(cNote){
      const diffs = cSeries.filter(v=>v!==null);
      if(!diffs.length){ cNote.textContent = "-"; }
      else {
        const avg = diffs.reduce((a,b)=>a+b,0)/diffs.length;
        const absAvg = diffs.reduce((a,b)=>a+Math.abs(b),0)/diffs.length;
        const sign = avg>=0 ? "+" : "";
        cNote.textContent = `Avg: ${sign}${Math.round(avg)} kcal (abs ${Math.round(absAvg)})`;
      }
    }
    if(sNote){
      const sVals = sSeries.filter(v=>v!==null);
      if(!sVals.length) sNote.textContent = "-";
      else {
        const avg = sVals.reduce((a,b)=>a+b,0)/sVals.length;
        sNote.textContent = `Avg: ${avg.toFixed(1)} h (14 days)`;
      }
    }

    // Weekday consistency table (8 weeks)
    const weeks = 8*7;
    const dList = lastNDays(today, weeks);

    const agg = Array.from({length:7}, ()=>({calOn:0, calLogged:0, sleepOn:0, sleepLogged:0}));
    for(const ds of dList){
      const d = parseYMD(ds);
      const dow = d.getDay();
      const rec = state.days[ds];
      if(rec && rec.calories!==null && rec.calories!==undefined){
        agg[dow].calLogged++;
        const tgt = targetFor(ds);
        if(Math.abs(Number(rec.calories)-tgt) <= win) agg[dow].calOn++;
      }
      if(rec && rec.sleepHours!==null && rec.sleepHours!==undefined){
        agg[dow].sleepLogged++;
        if(Number(rec.sleepHours) >= sleepTarget) agg[dow].sleepOn++;
      }
    }

    const rows = [];
    rows.push(`<div class="miniRow"><b>Day</b><b>Diet</b><b>Sleep</b></div>`);
    for(let dow=0; dow<7; dow++){
      const dName = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][dow];
      const a = agg[dow];
      const dietPct = a.calLogged ? Math.round(100*a.calOn/a.calLogged) : null;
      const sleepPct = a.sleepLogged ? Math.round(100*a.sleepOn/a.sleepLogged) : null;
      rows.push(`<div class="miniRow"><div><b>${dName}</b></div><div>${dietPct===null? "-" : dietPct+"%"}</div><div>${sleepPct===null? "-" : sleepPct+"%"}</div></div>`);
    }
    elWT.innerHTML = rows.join("");

    // Insights pill quick summary
    const insPill = safeEl("insightsPill");
    if(insPill){
      const d7 = compute7Day();
      let msg = "Log more data";
      let cls = "warn";
      if(d7.adh!==null && d7.avgSleep!==null){
        const diet = Math.round(d7.adh*100);
        const sl = d7.avgSleep.toFixed(1);
        msg = `Diet ${diet}% • Sleep ${sl}h`;
        cls = (diet>=75 && d7.avgSleep>=sleepTarget) ? "good" : (diet>=50 ? "warn" : "bad");
      } else if(d7.adh!==null){
        msg = `Diet ${Math.round(d7.adh*100)}%`;
        cls = (d7.adh>=0.75) ? "good" : (d7.adh>=0.50 ? "warn" : "bad");
      }
      setPill("insightsPill", cls, `<b>Insights:</b> ${msg}`);
    }
  }

function renderCoach(){
    const d7 = compute7Day();
    const nxt = nextWeighInTarget();

    const nextEl = document.getElementById("coachNextTarget");
    if(nxt){
      // Expected ranges are like "221.1 to 222.1" (lbs)
      const wt = (nxt.range || "").replace(" to ", "–") + " lb";
      const bf = (nxt.bfRange || "").replace(" to ", "–");
      nextEl.innerHTML = `
        <div class="coach-date">${fmtUSDate(nxt.ds)}</div>
        <div class="coach-metric"><span class="label">Weight:</span><strong>${wt}</strong></div>
        ${bf ? `<div class="coach-metric"><span class="label">Body fat:</span><strong>${bf}%</strong></div>` : ``}
      `;
    } else {
      nextEl.textContent = "-";
    }

    const start = parseYMD(state.settings.startDate);
    const week15Thu = addDays(start, (15-1)*7 + 3);
    const week15Ds = ymd(week15Thu);
    const week15Range = fmtRange(THU_WEEK_RANGES[14]).replace(" to ", "–") + " lb";
    const w15El = document.getElementById("coachWeek15");
    w15El.innerHTML = `
      <div class="coach-date">${fmtUSDate(week15Ds)}</div>
      <div class="coach-metric"><strong>${week15Range}</strong></div>
    `;

    const w0 = Number(state.settings.startWeight);
    const w  = getWeightBefore(ymd(new Date()));
    const kcalPerLb = Number(state.settings.kcalPerLb);
    const adj = Math.round((w - w0) * kcalPerLb);

    const dynEl = document.getElementById("coachDyn");
    if(!isFinite(adj)){
      dynEl.textContent = "-";
    } else if(adj === 0){
      dynEl.textContent = "Calories unchanged from start";
    } else {
      dynEl.textContent = `${adj > 0 ? "+" : ""}${adj} kcal vs start`;
    }

    let primary="Log calories consistently";
    let cls="warn";
    let pillText="Log data";

    if(d7.adh!==null){
      const pct = d7.adh;

      // If diet adherence is low, that's the first lever.
      if(pct < 0.75){
        primary = "Fix compliance first";
        cls = (pct < 0.50) ? "bad" : "warn";
        pillText = "Action needed";
      } else {
        // Diet is decent. Next lever is sleep (if we have it).
        const st = Number(state.settings.sleepTarget || 7.0);
        if(d7.avgSleep!==null && isFinite(st) && d7.avgSleep < st){
          primary = "Increase sleep consistency";
          cls = "warn";
          pillText = "Sleep";
        } else {
          primary = (pct>=0.90) ? "Stay the course" : "Tighten adherence";
          cls = (pct>=0.90) ? "good" : "warn";
          pillText = (pct>=0.90) ? "On track" : "Adjust";
        }
      }
    }

    document.getElementById("coachPrimary").textContent = primary;
    setPill("coachPill", cls, `<b>Guidance:</b> ${pillText}`);
    setPill("onTrackPill", cls, `<b>On track:</b> ${primary}`);
  }

  function renderAll(){
    buildTabs();
    renderActiveMonth();
    renderKpis();
    renderCoach();
    try{ renderTrends(); } catch {}
  }

  window.addEventListener("resize", ()=>{ renderActiveMonth(); });

  // IMPORTANT: do not call renderAll() here. initApp is the single entry point.
  initApp();

  });

</script>
</body>
</html>
